---
description: CRITICAL - Memory persistence enforcement for all agents. This rule always applies to ensure documentation changes are persisted to Qdrant.
globs: []
alwaysApply: true
---

# Memory Persistence Rule - Automatic Knowledge Base Sync

**CRITICAL**: This rule **ALWAYS APPLIES** to ALL agents (Cursor, Gemini CLI, any BMad agent) working on this project.

## ğŸ”’ Framework Independence

**IMPORTANT**: This rule file is kept **separate** from BMad framework files (`.cursor/rules/bmad/`) to survive BMad Method updates.

**Why this matters:**
- âœ… When you update BMad to v5, v6, etc., this file will **NOT** be overwritten
- âœ… BMad framework files in `bmad/` can be safely replaced during updates
- âœ… Project-specific rules stay in root `.cursor/rules/` directory
- âœ… `alwaysApply: true` ensures this rule loads for **every** agent automatically

**How it works:**
- This file has `alwaysApply: true` in frontmatter
- Cursor loads this rule **in addition to** any agent-specific rules
- No need to modify BMad framework files
- Survives all BMad Method updates

## Rule: Auto-Persist Documentation Changes

**Trigger**: Any time an agent creates or modifies ANY of these file types:
- âœ… Architecture Decision Records (ADRs) - `docs/architecture/adr/*.md`
- âœ… Architecture Documents - `docs/architecture/*.md`
- âœ… Stories - `docs/stories/*.story.md`
- âœ… PRD Documents - `docs/prd/*.md`
- âœ… Standards - `docs/standards/*.md`

**Required Actions** (Execute in order):

### 1. **Trigger Memory Update (Simple Method)**
After making ANY documentation changes, run this single command:

```bash
cd ~/Development/git_repos/gen-factory-memory && ./scripts/update_memory.sh
```

This will automatically:
- Ingest all documentation changes
- Verify persistence
- Show recent activity

### 2. **Advanced Verification (Optional)**
To verify a specific file was ingested:

```bash
cd ~/Development/git_repos/gen-factory-memory && \
./scripts/update_memory.sh --verify "path/to/changed/file.md"
```

### 3. **Report Status**
Inform the user:
- âœ… "Memory updated: [filename] has been ingested into Qdrant"
- âŒ "Memory update failed: [error message]"

### 4. **Alternative: Manual Method**
If the wrapper script fails, use manual commands:

```bash
# Step 1: Ingest
cd ~/Development/git_repos/gen-factory-memory && \
python3 scripts/bulk_ingest_gen_image_factory.py

# Step 2: Verify
cd ~/Development/git_repos/gen-factory-memory && \
python3 scripts/verify_ingestion.py --recent 5
```

## Enforcement

**Agents MUST**:
- âœ… Run ingestion script after EVERY doc update
- âœ… Verify persistence before considering the task complete
- âœ… Report any ingestion failures to the user
- âœ… Never silently skip memory updates

**Agents MUST NOT**:
- âŒ Skip ingestion "to save time"
- âŒ Assume previous ingestion is sufficient
- âŒ Mark tasks complete without verifying memory persistence
- âŒ Forget to update memory when editing docs via symlink

## Why This Matters

Without automatic persistence:
- ğŸš« Memory system becomes stale
- ğŸš« Future agents can't access recent decisions
- ğŸš« Semantic search returns outdated information
- ğŸš« The entire MCP integration is useless

## Exceptions

**Do NOT trigger ingestion for**:
- Source code files (`.js`, `.ts`, `.tsx`, etc.)
- Configuration files (`.json`, `.yml`, etc.)
- Test files
- Temporary/draft files
- Non-documentation markdown files (like `README.md` in root)

## Integration Points

### For Cursor Agents:
- This rule is auto-loaded from `.cursor/rules/` with `alwaysApply: true`
- Execute ingestion via `run_terminal_cmd` tool
- Use verification script to confirm persistence

### For Gemini CLI Agents:
- Load this rule at session start
- Execute ingestion via shell commands
- Parse verification output to confirm success

### For BMad Method Updates:
- This file is **NOT** part of BMad framework
- Safe to update `bmad/` subdirectory without affecting this rule
- Keeps project-specific memory workflow intact

## Example Workflow

```typescript
// Agent completes story 3.7, updates:
// - docs/stories/3.7.new-feature.story.md
// - docs/architecture/adr/ADR-018-New-Decision.md

// Step 1: Make the changes
edit("docs/stories/3.7.new-feature.story.md", ...);
edit("docs/architecture/adr/ADR-018-New-Decision.md", ...);

// Step 2: Trigger ingestion (REQUIRED by this rule)
run_terminal_cmd({
  command: "cd ~/Development/git_repos/gen-factory-memory && ./scripts/update_memory.sh",
  explanation: "Updating knowledge base with new story and ADR per memory-persistence.mdc"
});

// Step 3: Verify persistence (built into update_memory.sh)
// - Automatic verification happens
// - Shows recent activity
// - Reports success/failure

// Step 4: Report to user
console.log("âœ… Memory updated: Story 3.7 and ADR-018 ingested into Qdrant");
```

## Monitoring

Agents should track:
- ğŸ“Š Number of docs updated in session
- ğŸ“Š Number of successful ingestions
- ğŸ“Š Any ingestion failures
- ğŸ“Š Verification results

Report these metrics at the end of each session.

## References

- [Story 3.6: MCP Memory Integration](../../docs/stories/3.6.mcp-memory-integration.story.md)
- [MCP Setup Guide](../../docs/architecture/mcp-setup.md)
- [Obsidian Setup Guide](../../docs/architecture/obsidian-setup.md)
- [Memory Workflow Quickstart](../../docs/architecture/memory-workflow-quickstart.md)