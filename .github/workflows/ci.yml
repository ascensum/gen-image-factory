name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel superseded runs on main to avoid wasted minutes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref == 'refs/heads/main' }}

permissions:
  contents: read
  security-events: write
  actions: read

# Retry helper function for network operations
env:
  RETRY_MAX_ATTEMPTS: 5
  RETRY_DELAY_SECONDS: 10

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies for native modules
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "apt-get failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "apt-get failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Install dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm ci --ignore-scripts && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm ci failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm ci failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Rebuild native dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm rebuild && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm rebuild failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm rebuild failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Build
        run: npm run build

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies for native modules
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "apt-get failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "apt-get failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Install dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm ci --ignore-scripts && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm ci failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm ci failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Rebuild native dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm rebuild && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm rebuild failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm rebuild failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Run tests
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm test && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm test failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm test failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          # Focus CodeQL on data flow between Main and Renderer
          queries: security-extended,security-and-quality
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4
      - name: Analyze
        uses: github/codeql-action/analyze@v4

  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Semgrep
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            python -m pip install --upgrade pip semgrep && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "pip install failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "pip install failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Semgrep Scan (produce JSON + SARIF and set env based on results)
        run: |
          # Ensure jq is available for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

          # Initialize exit code variable
          semgrep_exit=0

          # Run semgrep using command-line config flags (Semgrep 1.146.0 has issues with YAML config files)
          # Using same rules as .semgrep.yml: p/owasp-electron, p/owasp-top-ten, p/javascript
          # Explicitly include: src/, electron/main.js, electron/preload.js, scripts/
          # Explicitly exclude: electron/renderer/ (build output, not source code)
          # Additional exclusions handled via .semgrepignore (tests, node_modules, etc.)
          # Note: --json and --sarif are mutually exclusive, so we run Semgrep twice
          # First run: Generate JSON output for result counting and error checking
          semgrep --config=p/owasp-electron --config=p/owasp-top-ten --config=p/javascript --json --json-output=semgrep.json src/ electron/main.js electron/preload.js scripts/ || semgrep_exit=$?
          
          # Second run: Generate SARIF output for GitHub Security upload (only if first run succeeded or had findings)
          if [ "$semgrep_exit" -eq 0 ] || [ "$semgrep_exit" -eq 1 ] || [ "$semgrep_exit" -eq 7 ]; then
            # Exit codes 0, 1, and 7 are valid (0=no findings, 1/7=findings found)
            semgrep --config=p/owasp-electron --config=p/owasp-top-ten --config=p/javascript --sarif --sarif-output=semgrep.sarif src/ electron/main.js electron/preload.js scripts/ || true
          fi
          
          # Check if Semgrep failed due to errors (not security findings)
          if [ -f semgrep.json ]; then
            config_errors=$(jq '.errors[]? | select(.code == 4 or .code == 7) | .code' semgrep.json 2>/dev/null | wc -l)
            if [ "$config_errors" -gt 0 ]; then
              echo "ERROR: Semgrep encountered errors - security scanning may be incomplete!"
              echo "Errors:"
              jq '.errors[]? | {code: .code, message: .short_msg, long_msg: .long_msg}' semgrep.json
              # Don't exit here - we still need to create SARIF file for upload
            fi
          elif [ "$semgrep_exit" -ne 0 ] && [ "$semgrep_exit" -ne 1 ] && [ "$semgrep_exit" -ne 7 ]; then
            # Exit codes 1 and 7 are normal (findings found), other codes are errors
            echo "WARNING: Semgrep failed to run (exit code: $semgrep_exit)"
            echo "This may be due to missing paths or Semgrep installation issues"
            # Continue to create empty SARIF file
          fi

          # Count results in the JSON output reliably
          results_count=$(jq '[.results[]?] | length' semgrep.json 2>/dev/null || echo 0)
          echo "Semgrep results_count=$results_count"

          if [ "$results_count" -gt 0 ]; then
            echo "SEMGREP_FAILED=true" >> $GITHUB_ENV
          else
            echo "SEMGREP_FAILED=false" >> $GITHUB_ENV
          fi

          # ALWAYS ensure SARIF exists and has valid structure (at least one run) even if empty
          # This is required for the upload step to succeed
          if [ ! -f semgrep.sarif ]; then
            echo "Creating valid empty SARIF file (semgrep.sarif was not generated)"
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Semgrep","version":"0.0.0"}},"results":[]}]}' > semgrep.sarif
          else
            # Ensure SARIF has at least one run (GitHub requires this)
            runs_count=$(jq '.runs | length' semgrep.sarif 2>/dev/null || echo 0)
            if [ "$runs_count" -eq 0 ]; then
              echo "Warning: SARIF has no runs - adding empty run"
              jq '.runs = [{"tool":{"driver":{"name":"Semgrep","version":"0.0.0"}},"results":[]}]' semgrep.sarif > semgrep.sarif.tmp && mv semgrep.sarif.tmp semgrep.sarif
            fi
          fi
          
          # Verify SARIF file exists before proceeding
          if [ ! -f semgrep.sarif ]; then
            echo "ERROR: Failed to create semgrep.sarif file"
            exit 1
          fi
          
          echo "SARIF file created successfully:"
          ls -lh semgrep.sarif

      - name: Debug semgrep outputs
        run: |
          echo "semgrep.json size:"
          ls -lh semgrep.json || true
          echo "semgrep.sarif size:"
          ls -lh semgrep.sarif || true
          echo "SARIF runs and total_results:"
          jq '{runs: (.runs|length), total_results: ([.runs[].results[]?] | length)}' semgrep.sarif || true
          echo "Top semgrep.json results (first 200 lines):"
          jq '.results[] | {path:.path, start:.start, rule_id:.check_id, message:.extra.message}' semgrep.json | sed -n '1,200p' || true

      - name: Verify SARIF file exists
        run: |
          ls -lh semgrep.sarif || echo "SARIF file missing"
          file semgrep.sarif || echo "SARIF file validation failed"

      - name: Upload Semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
          wait-for-processing: true

      - name: Check Semgrep Status
        if: env.SEMGREP_FAILED == 'true'
        run: |
          echo "Semgrep found high-severity issues. Check the Security tab."
          exit 1

  socket-dev:
    name: Socket.dev Supply Chain Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies for native modules
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "apt-get failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "apt-get failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Install dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm ci --ignore-scripts && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm ci failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm ci failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Rebuild native dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm rebuild && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm rebuild failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm rebuild failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Run Socket.dev scan
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            socket_output=$(npx socket audit 2>&1 || true)
            # Check if it's a network error vs actual findings
            if echo "$socket_output" | grep -qiE "ETIMEDOUT|ECONNRESET|ENOTFOUND|network|timeout|failed to fetch"; then
              if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
                echo "Socket.dev network error, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
                sleep ${{ env.RETRY_DELAY_SECONDS }}
                continue
              else
                echo "Socket.dev network error after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
                exit 1
              fi
            fi
            # Check for high-risk findings (not network errors)
            if echo "$socket_output" | grep -qi "high-risk\|critical\|malicious"; then
              echo "High-risk supply-chain issues detected"
              echo "$socket_output"
              exit 1
            fi
            # Success - no network errors and no high-risk findings
            break
          done

  npm-audit:
    name: npm Audit (High Severity)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm ci --ignore-scripts && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm ci failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm ci failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Run npm audit (high severity only)
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            if npm audit --audit-level=high; then
              echo "npm audit passed - no high-severity vulnerabilities found"
              break
            else
              audit_exit=$?
              if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
                echo "npm audit failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
                sleep ${{ env.RETRY_DELAY_SECONDS }}
              else
                echo "npm audit found high-severity vulnerabilities - this blocks the workflow!"
                echo "Run 'npm audit' locally to see details, or 'npm audit fix' to attempt automatic fixes."
                exit $audit_exit
              fi
            fi
          done
