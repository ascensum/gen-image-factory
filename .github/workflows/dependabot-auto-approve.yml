name: Dependabot Auto-Approve

on:
  pull_request_target:

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    # Only run for Dependabot
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      # Approve and enable auto-merge for Minor/Patch updates
      - name: Auto-approve and Enable Auto-merge
        if: steps.metadata.outputs.update-type != 'version-update:semver-major'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            
            // Approve the PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE'
            });
            
            // Enable auto-merge with squash strategy using GraphQL
            const mutation = `
              mutation enableAutoMerge($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: $mergeMethod
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                      mergeMethod
                    }
                  }
                }
              }
            `;
            
            // Get PR node ID first
            const prQuery = `
              query getPR($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $number) {
                    id
                  }
                }
              }
            `;
            
            const prResult = await github.graphql(prQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: prNumber
            });
            
            const pullRequestId = prResult.repository.pullRequest.id;
            
            // Enable auto-merge
            await github.graphql(mutation, {
              pullRequestId: pullRequestId,
              mergeMethod: 'SQUASH'
            });
            
            console.log(`Approved and enabled auto-merge for PR #${prNumber}`);

