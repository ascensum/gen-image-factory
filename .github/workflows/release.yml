name: Release

on:
  push:
    tags:
      - 'v*.*.*'

# Cancel superseded runs to avoid wasted minutes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  security-events: write
  actions: read

# Retry helper function for network operations
env:
  RETRY_MAX_ATTEMPTS: 5
  RETRY_DELAY_SECONDS: 10

jobs:
  # Quality Gates: All must pass before artifact build
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies for native modules
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "apt-get failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "apt-get failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Install dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm ci --ignore-scripts && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm ci failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm ci failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Rebuild native dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm rebuild && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm rebuild failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm rebuild failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Run unit and integration tests
        run: npm run test:run

      - name: Run npm audit (high severity only, production dependencies)
        run: |
          # Only audit production dependencies to avoid blocking on dev-only tool vulnerabilities
          # electron-icon-builder has vulnerabilities in its dependencies but is only used for icon generation
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            if npm audit --audit-level=high --omit=dev; then
              echo "npm audit passed - no high-severity vulnerabilities found in production dependencies"
              break
            else
              audit_exit=$?
              if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
                echo "npm audit failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
                sleep ${{ env.RETRY_DELAY_SECONDS }}
              else
                echo "npm audit found high-severity vulnerabilities in production dependencies - this blocks the workflow!"
                exit $audit_exit
              fi
            fi
          done

      - name: Run Socket.dev scan
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            socket_output=$(npx socket audit 2>&1 || true)
            if echo "$socket_output" | grep -qiE "ETIMEDOUT|ECONNRESET|ENOTFOUND|network|timeout|failed to fetch"; then
              if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
                echo "Socket.dev network error, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
                sleep ${{ env.RETRY_DELAY_SECONDS }}
                continue
              else
                echo "Socket.dev network error after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
                exit 1
              fi
            fi
            if echo "$socket_output" | grep -qi "high-risk\|critical\|malicious"; then
              echo "High-risk supply-chain issues detected"
              echo "$socket_output"
              exit 1
            fi
            break
          done

      - name: CodeQL Security Scan
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

      - name: CodeQL Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v4

      - name: Semgrep Security Scan
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          python -m pip install --upgrade pip semgrep
          semgrep --config=p/owasp-top-ten --config=p/javascript --exclude=electron/renderer/** --json --json-output=semgrep.json src/ electron/main.js electron/preload.js scripts/ || semgrep_exit=$?
          if [ "$semgrep_exit" -ne 0 ] && [ "$semgrep_exit" -ne 1 ] && [ "$semgrep_exit" -ne 7 ]; then
            echo "ERROR: Semgrep failed to run (exit code: $semgrep_exit)"
            exit 1
          fi
          results_count=$(jq '[.results[]?] | length' semgrep.json 2>/dev/null || echo 0)
          if [ "$results_count" -gt 0 ]; then
            echo "Semgrep found security issues"
            exit 1
          fi

  # E2E Tests: Run on version tags before artifact build
  e2e-tests:
    name: E2E Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Rebuild native dependencies
        run: npm rebuild

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run E2E tests
        env:
          ELECTRON_DISABLE_SANDBOX: 1 # Essential for Linux CI
          CI: true
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            # Linux requires xvfb for headless display
            echo "Running E2E tests on Linux with xvfb"
            xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" npm run test:e2e -- --project=chromium
          else
            # Windows and macOS do not use xvfb
            echo "Running E2E tests on ${{ matrix.os }}"
            npm run test:e2e -- --project=chromium
          fi
        shell: bash

  # Build artifacts for all platforms
  build-artifacts:
    name: Build ${{ matrix.platform }}
    needs: [quality-gates, e2e-tests]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win
            os: windows-latest
            target: win
          - platform: mac
            os: macos-latest
            target: mac
          - platform: linux
            os: ubuntu-latest
            target: linux
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies (Linux only)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev

      - name: Install dependencies
        run: npm ci

      - name: Rebuild native dependencies
        run: npm rebuild

      - name: Update package.json version from git tag
        run: |
          # Extract version from git tag (e.g., v1.0.2 -> 1.0.2)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating package.json version to $VERSION"
          
          # Update package.json version (doesn't create a commit)
          npm version $VERSION --no-git-tag-version --allow-same-version
          
          # Verify the update
          echo "Updated version: $(node -p "require('./package.json').version")"
        shell: bash

      - name: Build application
        run: npm run build

      - name: Validate renderer build output
        shell: pwsh
        run: |
          Write-Host "=== Validating Renderer Build Output ===" -ForegroundColor Cyan
          
          # Check renderer file location (configured as electron/renderer in vite.config.ts)
          $rendererPath = "electron/renderer"
          if (-Not (Test-Path $rendererPath)) {
            Write-Host "WARNING: electron/renderer not found, checking dist/renderer..." -ForegroundColor Yellow
            if (Test-Path "dist/renderer") {
              $rendererPath = "dist/renderer"
            } else {
              Write-Error "ERROR: Renderer files not found in either electron/renderer or dist/renderer!"
              Write-Host "`nProject structure for debugging:"
              Get-ChildItem -Depth 1 | Select-Object Name, Mode | Format-Table -AutoSize
              exit 1
            }
          }
          
          Write-Host "Found renderer files in: $rendererPath" -ForegroundColor Green
          
          # Check for critical files
          $requiredFiles = @("$rendererPath/index.html", "electron/main.js", "electron/preload.js")
          $missingFiles = @()
          foreach ($file in $requiredFiles) {
            if (-Not (Test-Path $file)) {
              $missingFiles += $file
            } else {
              Write-Host "Found: $file" -ForegroundColor Green
            }
          }
          
          if ($missingFiles.Count -gt 0) {
            Write-Error "ERROR: Required files missing: $($missingFiles -join ', ')"
            exit 1
          }
          
          Write-Host "`nAll required files present!" -ForegroundColor Green

      - name: Debug Windows MSIX Build (Windows only)
        if: matrix.platform == 'win'
        env:
          MS_STORE_IDENTITY_NAME: ${{ secrets.MS_STORE_IDENTITY_NAME }}
          MS_STORE_PUBLISHER_ID: ${{ secrets.MS_STORE_PUBLISHER_ID }}
          MS_STORE_PUBLISHER_DISPLAY_NAME: ${{ secrets.MS_STORE_PUBLISHER_DISPLAY_NAME }}
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        shell: pwsh
        run: |
          Write-Host "=== DEBUG: Environment Variables Check ===" -ForegroundColor Cyan
          Write-Host "MS_STORE_IDENTITY_NAME length: $($env:MS_STORE_IDENTITY_NAME ? $env:MS_STORE_IDENTITY_NAME.Length : 0)"
          Write-Host "MS_STORE_PUBLISHER_ID starts with CN=: $($env:MS_STORE_PUBLISHER_ID ? $env:MS_STORE_PUBLISHER_ID.StartsWith('CN=') : 'N/A')"
          
          if ($env:WINDOWS_PFX_BASE64) {
            try {
              $pfxBytes = [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64)
              $pfxPath = Join-Path $env:RUNNER_TEMP "cert.pfx"
              [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
              
              # Try to read the certificate and extract the EXACT subject
              try {
                $cert = Get-PfxCertificate -FilePath $pfxPath -Password (ConvertTo-SecureString -String $env:WINDOWS_PFX_PASSWORD -AsPlainText -Force)
                Write-Host "Certificate validated. Subject: $($cert.Subject)"
                
                # Always use the exact subject from the certificate for publisherName
                Write-Host "Setting MS_STORE_PUBLISHER_ID from certificate subject to ensure exact match"
                echo "MS_STORE_PUBLISHER_ID=$($cert.Subject)" | Out-File -FilePath $env:GITHUB_ENV -Append
              } catch {
                Write-Host "ERROR: Failed to read PFX certificate: $_" -ForegroundColor Red
              }
            } catch {
              Write-Host "ERROR: Failed to decode or write PFX: $_" -ForegroundColor Red
            }
          }

      - name: Build artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MS_STORE_IDENTITY_NAME: ${{ secrets.MS_STORE_IDENTITY_NAME }}
          MS_STORE_PUBLISHER_ID: ${{ secrets.MS_STORE_PUBLISHER_ID }}
          MS_STORE_PUBLISHER_DISPLAY_NAME: ${{ secrets.MS_STORE_PUBLISHER_DISPLAY_NAME }}
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        shell: pwsh
        run: |
          Write-Host "Building for platform: ${{ matrix.platform }}"
          
          if ("${{ matrix.platform }}" -eq "win") {
            if ($env:WINDOWS_PFX_BASE64) {
              $pfxPath = Join-Path $env:RUNNER_TEMP "cert.pfx"
              # Ensure PFX exists (might have been created in debug step)
              if (-Not (Test-Path $pfxPath)) {
                $pfxBytes = [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64)
                [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
              }
              $env:WIN_CSC_LINK = $pfxPath
              $env:WIN_CSC_KEY_PASSWORD = $env:WINDOWS_PFX_PASSWORD
            }
            
            $builder = "./node_modules/.bin/electron-builder.cmd"
            $publisherArg = if ($env:MS_STORE_PUBLISHER_ID) { "-c.win.publisherName=`"$env:MS_STORE_PUBLISHER_ID`"" } else { "" }
            
            Write-Host "Command: $builder --win appx nsis --x64 --config electron-builder.config.js --publish never $publisherArg"
            & $builder --win appx nsis --x64 --config electron-builder.config.js --publish never $publisherArg
            
          } elseif ("${{ matrix.platform }}" -eq "mac") {
            npx electron-builder --config electron-builder.config.js --mac --publish never
          } else {
            npx electron-builder --config electron-builder.config.js --linux --publish never
          }

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Production Smoke Test
        env:
          ELECTRON_DISABLE_SANDBOX: 1
          CI: true
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" npx playwright test tests/e2e/workflows/production-smoke.e2e.test.js
          else
            npx playwright test tests/e2e/workflows/production-smoke.e2e.test.js
          fi
        shell: bash

      - name: Generate SHA-256 checksums
        shell: pwsh
        run: |
          if (-Not (Test-Path "dist")) {
            Write-Error "ERROR: 'dist' directory was not created! Listing directory for debug:"
            Get-ChildItem -Recurse | Select-Object FullName
            exit 1
          }
          Set-Location dist
          $checksumFile = "SHA256SUMS-${{ matrix.platform }}.txt"
          Get-ChildItem -Recurse -File | ForEach-Object {
            if ($_.Name -notlike "SHA256SUMS-*.txt") {
              $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
              "$hash  $($_.Name)" | Out-File -FilePath $checksumFile -Append -Encoding utf8
            }
          }

      - name: Generate SBOM
        run: |
          npm install -g @cyclonedx/cyclonedx-npm
          cyclonedx-npm --output-file dist/SBOM.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.platform }}
          path: |
            dist/**
            !dist/node_modules/**
          retention-days: 30

  # Create GitHub Release and upload artifacts
  release:
    name: Create Release
    needs: [build-artifacts]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Filter artifacts to only installers
        run: |
          # Create a filtered directory with only installer files
          mkdir -p artifacts-filtered
          
          # Windows installers (exclude unpacked binaries and helper executables)
          # We look for files that are likely installers and NOT inside 'unpacked' directories
          find artifacts -type f \( -name "*Setup*.exe" -o -name "GenImageFactory*.exe" -o -name "*.msix" -o -name "*.appx" \) \
            -not -path "*/win-unpacked/*" \
            -not -path "*/linux-unpacked/*" \
            -not -path "*/mac/*" \
            -not -name "elevate.exe" \
            -exec cp {} artifacts-filtered/ \;
          
          # macOS installers
          find artifacts -type f \( -name "*.dmg" -o -name "*-mac.zip" \) -exec cp {} artifacts-filtered/ \;
          
          # Linux installers
          find artifacts -type f \( -name "*.AppImage" -o -name "*.deb" \) -exec cp {} artifacts-filtered/ \;
          
          # Checksums (platform-specific) and SBOM
          find artifacts -type f \( -name "SHA256SUMS-*.txt" -o -name "*SBOM.json" \) -exec cp {} artifacts-filtered/ \;
          
          # List what will be uploaded
          echo "Files to upload:"
          ls -lh artifacts-filtered/
        shell: bash

      - name: Create or Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are any files to upload
          if [ -z "$(ls -A artifacts-filtered/)" ]; then
            echo "ERROR: No artifacts found in artifacts-filtered/ directory!"
            exit 1
          fi
          
          # Check if release exists
          if gh release view ${{ github.ref_name }} >/dev/null 2>&1; then
            echo "Updating existing release ${{ github.ref_name }}"
            gh release upload ${{ github.ref_name }} artifacts-filtered/* --clobber
          else
            echo "Creating new release ${{ github.ref_name }}"
            gh release create ${{ github.ref_name }} \
              --title "Release ${{ github.ref_name }}" \
              --notes "## What's Changed in this Version\n\nCategorized changes will be listed here.\n\n### ðŸ“¦ Artifacts\n- **Windows**: MSIX (Microsoft Store), NSIS installer, Portable\n- **macOS**: DMG, ZIP\n- **Linux**: AppImage, DEB\n\n### ðŸ”’ Integrity\n- SHA-256 checksums included for all artifacts\n- SBOM (Software Bill of Materials) included for auditability\n\n### ðŸ“¥ Installation\nSee [Release Documentation](docs/release-guide.md) for platform-specific installation instructions." \
              --generate-notes \
              artifacts-filtered/*
          fi
        shell: bash

