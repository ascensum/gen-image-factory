name: Release

on:
  push:
    tags:
      - 'v*.*.*'

# Cancel superseded runs to avoid wasted minutes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  security-events: write
  actions: read

# Retry helper function for network operations
env:
  RETRY_MAX_ATTEMPTS: 5
  RETRY_DELAY_SECONDS: 10

jobs:
  # Quality Gates: All must pass before artifact build
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies for native modules
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "apt-get failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "apt-get failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Install dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm ci --ignore-scripts && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm ci failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm ci failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Rebuild native dependencies
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            npm rebuild && break
            if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
              echo "npm rebuild failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
              sleep ${{ env.RETRY_DELAY_SECONDS }}
            else
              echo "npm rebuild failed after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
              exit 1
            fi
          done

      - name: Run unit and integration tests
        run: npm run test:run

      - name: Run npm audit (high severity only, production dependencies)
        run: |
          # Only audit production dependencies to avoid blocking on dev-only tool vulnerabilities
          # electron-icon-builder has vulnerabilities in its dependencies but is only used for icon generation
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            if npm audit --audit-level=high --omit=dev; then
              echo "npm audit passed - no high-severity vulnerabilities found in production dependencies"
              break
            else
              audit_exit=$?
              if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
                echo "npm audit failed, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
                sleep ${{ env.RETRY_DELAY_SECONDS }}
              else
                echo "npm audit found high-severity vulnerabilities in production dependencies - this blocks the workflow!"
                exit $audit_exit
              fi
            fi
          done

      - name: Run Socket.dev scan
        run: |
          for i in $(seq 1 ${{ env.RETRY_MAX_ATTEMPTS }}); do
            socket_output=$(npx socket audit 2>&1 || true)
            if echo "$socket_output" | grep -qiE "ETIMEDOUT|ECONNRESET|ENOTFOUND|network|timeout|failed to fetch"; then
              if [ $i -lt ${{ env.RETRY_MAX_ATTEMPTS }} ]; then
                echo "Socket.dev network error, retrying in ${{ env.RETRY_DELAY_SECONDS }} seconds (attempt $i/${{ env.RETRY_MAX_ATTEMPTS }})..."
                sleep ${{ env.RETRY_DELAY_SECONDS }}
                continue
              else
                echo "Socket.dev network error after ${{ env.RETRY_MAX_ATTEMPTS }} attempts"
                exit 1
              fi
            fi
            if echo "$socket_output" | grep -qi "high-risk\|critical\|malicious"; then
              echo "High-risk supply-chain issues detected"
              echo "$socket_output"
              exit 1
            fi
            break
          done

      - name: CodeQL Security Scan
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

      - name: CodeQL Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v4

      - name: Semgrep Security Scan
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          python -m pip install --upgrade pip semgrep
          semgrep --config=p/owasp-top-ten --config=p/javascript --exclude=electron/renderer/** --json --json-output=semgrep.json src/ electron/main.js electron/preload.js scripts/ || semgrep_exit=$?
          if [ "$semgrep_exit" -ne 0 ] && [ "$semgrep_exit" -ne 1 ] && [ "$semgrep_exit" -ne 7 ]; then
            echo "ERROR: Semgrep failed to run (exit code: $semgrep_exit)"
            exit 1
          fi
          results_count=$(jq '[.results[]?] | length' semgrep.json 2>/dev/null || echo 0)
          if [ "$results_count" -gt 0 ]; then
            echo "Semgrep found security issues"
            exit 1
          fi

  # E2E Tests: Run on version tags before artifact build
  e2e-tests:
    name: E2E Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Rebuild native dependencies
        run: npm rebuild

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run E2E tests
        env:
          ELECTRON_DISABLE_SANDBOX: 1 # Essential for Linux CI
          CI: true
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            # Linux requires xvfb for headless display
            echo "Running E2E tests on Linux with xvfb"
            xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" npm run test:e2e -- --project=chromium
          else
            # Windows and macOS do not use xvfb
            echo "Running E2E tests on ${{ matrix.os }}"
            npm run test:e2e -- --project=chromium
          fi
        shell: bash

  # Build artifacts for all platforms
  build-artifacts:
    name: Build ${{ matrix.platform }}
    needs: [quality-gates, e2e-tests]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win
            os: windows-latest
            target: win
          - platform: mac
            os: macos-latest
            target: mac
          - platform: linux
            os: ubuntu-latest
            target: linux
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build dependencies (Linux only)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential python3 libvips-dev libsecret-1-dev

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Rebuild native dependencies
        run: npm rebuild

      - name: Update package.json version from git tag
        run: |
          # Extract version from git tag (e.g., v1.0.2 -> 1.0.2)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating package.json version to $VERSION"
          
          # Update package.json version (doesn't create a commit)
          npm version $VERSION --no-git-tag-version --allow-same-version
          
          # Verify the update
          echo "Updated version: $(node -p "require('./package.json').version")"
        shell: bash

      - name: Build application
        run: npm run build

      - name: Debug Windows MSIX Build (Windows only)
        if: matrix.platform == 'win'
        env:
          MS_STORE_IDENTITY_NAME: ${{ secrets.MS_STORE_IDENTITY_NAME }}
          MS_STORE_PUBLISHER_ID: ${{ secrets.MS_STORE_PUBLISHER_ID }}
          MS_STORE_PUBLISHER_DISPLAY_NAME: ${{ secrets.MS_STORE_PUBLISHER_DISPLAY_NAME }}
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        shell: pwsh
        run: |
          Write-Host "=== DEBUG: Environment Variables Check ===" -ForegroundColor Cyan
          Write-Host "MS_STORE_IDENTITY_NAME: $($env:MS_STORE_IDENTITY_NAME -ne $null ? 'SET (length: ' + $env:MS_STORE_IDENTITY_NAME.Length + ')' : 'NOT SET')"
          Write-Host "MS_STORE_PUBLISHER_ID: $($env:MS_STORE_PUBLISHER_ID -ne $null ? 'SET (starts with CN=: ' + $env:MS_STORE_PUBLISHER_ID.StartsWith('CN=') + ')' : 'NOT SET')"
          Write-Host "MS_STORE_PUBLISHER_DISPLAY_NAME: $($env:MS_STORE_PUBLISHER_DISPLAY_NAME -ne $null ? 'SET' : 'NOT SET')"
          Write-Host "WINDOWS_PFX_BASE64: $($env:WINDOWS_PFX_BASE64 -ne $null ? 'SET (length: ' + $env:WINDOWS_PFX_BASE64.Length + ')' : 'NOT SET')"
          Write-Host "WINDOWS_PFX_PASSWORD: $($env:WINDOWS_PFX_PASSWORD -ne $null ? 'SET' : 'NOT SET')"
          
          Write-Host "`n=== DEBUG: Certificate Validation ===" -ForegroundColor Cyan
          if ($env:WINDOWS_PFX_BASE64) {
            try {
              $pfxBytes = [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64)
              $pfxPath = Join-Path $env:RUNNER_TEMP "cert.pfx"
              [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
              Write-Host "PFX file written to: $pfxPath"
              Write-Host "PFX file size: $((Get-Item $pfxPath).Length) bytes"
              
              # Try to read the certificate
              try {
                $cert = Get-PfxCertificate -FilePath $pfxPath -Password (ConvertTo-SecureString -String $env:WINDOWS_PFX_PASSWORD -AsPlainText -Force)
                Write-Host "Certificate validated successfully"
                Write-Host "Certificate subject: $($cert.Subject)"
                Write-Host "Certificate issuer: $($cert.Issuer)"
                Write-Host "Certificate thumbprint: $($cert.Thumbprint)"
              } catch {
                Write-Host "ERROR: Failed to read PFX certificate: $_" -ForegroundColor Red
              }
            } catch {
              Write-Host "ERROR: Failed to decode or write PFX: $_" -ForegroundColor Red
            }
          } else {
            Write-Host "WARNING: WINDOWS_PFX_BASE64 is not set" -ForegroundColor Yellow
          }
          
          Write-Host "`n=== DEBUG: Directory Structure Before Build ===" -ForegroundColor Cyan
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "`nTop-level files and directories:"
          Get-ChildItem -Depth 0 | Select-Object Name, Mode, Length | Format-Table -AutoSize
          Write-Host "`nChecking for dist directory:"
          if (Test-Path "dist") {
            Write-Host "dist/ exists with contents:"
            Get-ChildItem -Path "dist" -Recurse | Select-Object FullName | Format-Table -AutoSize
          } else {
            Write-Host "dist/ does not exist yet"
          }
          
          Write-Host "`n=== DEBUG: electron-builder.js Configuration ===" -ForegroundColor Cyan
          if (Test-Path "electron-builder.js") {
            Get-Content "electron-builder.js" | Write-Host
          } else {
            Write-Host "ERROR: electron-builder.js not found!" -ForegroundColor Red
          }

      - name: Build artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MS_STORE_IDENTITY_NAME: ${{ secrets.MS_STORE_IDENTITY_NAME }}
          MS_STORE_PUBLISHER_ID: ${{ secrets.MS_STORE_PUBLISHER_ID }}
          MS_STORE_PUBLISHER_DISPLAY_NAME: ${{ secrets.MS_STORE_PUBLISHER_DISPLAY_NAME }}
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        shell: pwsh
        run: |
          Write-Host "Building for platform: ${{ matrix.platform }}"
          
          # For Windows, decode the base64 PFX and set up code-signing
          if ("${{ matrix.platform }}" -eq "win") {
            if ($env:WINDOWS_PFX_BASE64) {
              # Decode base64 PFX and write to temp file
              $pfxBytes = [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64)
              $pfxPath = Join-Path $env:RUNNER_TEMP "cert.pfx"
              [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
              
              # Set electron-builder code-signing variables
              $env:CSC_LINK = $pfxPath
              $env:CSC_KEY_PASSWORD = $env:WINDOWS_PFX_PASSWORD
              
              Write-Host "Code-signing certificate configured: $pfxPath"
              Write-Host "CSC_LINK: $env:CSC_LINK"
              Write-Host "CSC_KEY_PASSWORD: $($env:CSC_KEY_PASSWORD -ne $null ? 'SET' : 'NOT SET')"
            }
            
            Write-Host "`n=== DEBUG: Checking Application Files Before Build ===" -ForegroundColor Cyan
            Write-Host "Checking electron/ directory:"
            if (Test-Path "electron") {
              Get-ChildItem -Path "electron" -Recurse -File | Select-Object FullName | Format-Table -AutoSize
            } else {
              Write-Host "ERROR: electron/ directory not found!" -ForegroundColor Red
            }
            
            Write-Host "`n=== DEBUG: Testing Combined Build (NSIS + APPX) ===" -ForegroundColor Cyan
            # Build both targets together instead of separately
            Write-Host "Running: npx electron-builder --config electron-builder.js --win --x64 --publish never --log-level=debug"
            
            # Capture output properly in PowerShell
            $buildOutput = ""
            $buildExitCode = 0
            
            # Run electron-builder and capture all output
            $process = Start-Process -FilePath "npx" -ArgumentList "electron-builder", "--config", "electron-builder.js", "--win", "--x64", "--publish", "never", "--log-level=debug" -NoNewWindow -Wait -PassThru -RedirectStandardOutput "electron-builder-output.txt" -RedirectStandardError "electron-builder-error.txt"
            $buildExitCode = $process.ExitCode
            
            # Read the output files
            if (Test-Path "electron-builder-output.txt") {
              $buildOutput = Get-Content "electron-builder-output.txt" -Raw
              Write-Host "=== Electron-Builder Output ===" -ForegroundColor Cyan
              Write-Host $buildOutput
            }
            
            if (Test-Path "electron-builder-error.txt") {
              $errorOutput = Get-Content "electron-builder-error.txt" -Raw
              if ($errorOutput) {
                Write-Host "=== Electron-Builder Errors ===" -ForegroundColor Red
                Write-Host $errorOutput
              }
            }
            
            Write-Host "`nBuild exit code: $buildExitCode" -ForegroundColor $(if ($buildExitCode -eq 0) { "Green" } else { "Red" })
            
            Write-Host "`n=== DEBUG: Directory Structure After Build ===" -ForegroundColor Cyan
            Write-Host "Current directory: $(Get-Location)"
            Write-Host "`nChecking for dist directory:"
            if (Test-Path "dist") {
              Write-Host "dist/ exists with contents:" -ForegroundColor Green
              Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length | Format-Table -AutoSize
            } else {
              Write-Host "WARNING: dist/ was not created!" -ForegroundColor Yellow
              Write-Host "`nListing all directories in current location:"
              Get-ChildItem -Directory | Select-Object Name | Format-Table -AutoSize
              Write-Host "`nChecking if electron-builder created files elsewhere:"
              Get-ChildItem -Recurse -Filter "*.msix" -ErrorAction SilentlyContinue | Select-Object FullName
              Get-ChildItem -Recurse -Filter "*.appx" -ErrorAction SilentlyContinue | Select-Object FullName
              Get-ChildItem -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object FullName
            }
            
            # Fail if build failed or dist doesn't exist
            if ($buildExitCode -ne 0) {
              Write-Host "ERROR: Build failed with exit code $buildExitCode" -ForegroundColor Red
              exit 1
            }
            
            if (-Not (Test-Path "dist")) {
              Write-Host "ERROR: Build succeeded but dist/ directory was not created!" -ForegroundColor Red
              exit 1
            }
          } elseif ("${{ matrix.platform }}" -eq "mac") {
            npx electron-builder --config electron-builder.js --mac --publish never
          } else {
            npx electron-builder --config electron-builder.js --linux --publish never
          }

      - name: Generate SHA-256 checksums
        shell: pwsh
        run: |
          if (-Not (Test-Path "dist")) {
            Write-Error "ERROR: 'dist' directory was not created! Listing directory for debug:"
            Get-ChildItem -Recurse | Select-Object FullName
            exit 1
          }
          Set-Location dist
          Get-ChildItem -Recurse -File | ForEach-Object {
            if ($_.Name -ne "SHA256SUMS.txt") {
              $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
              "$hash  $($_.Name)" | Out-File -FilePath "SHA256SUMS.txt" -Append -Encoding utf8
            }
          }

      - name: Generate SBOM
        run: |
          npm install -g @cyclonedx/cyclonedx-npm
          cyclonedx-npm --output-file dist/SBOM.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.platform }}
          path: |
            dist/**
            !dist/node_modules/**
          retention-days: 30

  # Create GitHub Release and upload artifacts
  release:
    name: Create Release
    needs: [build-artifacts]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Filter artifacts to only installers
        run: |
          # Create a filtered directory with only installer files
          mkdir -p artifacts-filtered
          
          # Windows installers (exclude helper executables like elevate.exe)
          find artifacts -type f \( -name "*Setup*.exe" -o -name "Gen Image Factory*.exe" -o -name "*.msix" -o -name "*.appx" \) ! -name "elevate.exe" -exec cp {} artifacts-filtered/ \;
          
          # macOS installers
          find artifacts -type f \( -name "*.dmg" -o -name "*-mac.zip" \) -exec cp {} artifacts-filtered/ \;
          
          # Linux installers
          find artifacts -type f \( -name "*.AppImage" -o -name "*.deb" \) -exec cp {} artifacts-filtered/ \;
          
          # Checksums and SBOM
          find artifacts -type f \( -name "*SHA256SUMS.txt" -o -name "*SBOM.json" \) -exec cp {} artifacts-filtered/ \;
          
          # List what will be uploaded
          echo "Files to upload:"
          ls -lh artifacts-filtered/
        shell: bash

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          body: |
            ## What's Changed in this Version
            
            <!-- GitHub will automatically insert categorized changes here based on .github/release.yml -->
            
            ### ðŸ“¦ Artifacts
            - **Windows**: MSIX (Microsoft Store), NSIS installer, Portable
            - **macOS**: DMG, ZIP
            - **Linux**: AppImage, DEB
            
            ### ðŸ”’ Integrity
            - SHA-256 checksums included for all artifacts
            - SBOM (Software Bill of Materials) included for auditability
            
            ### ðŸ“¥ Installation
            See [Release Documentation](docs/release-guide.md) for platform-specific installation instructions.
          files: |
            artifacts-filtered/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

