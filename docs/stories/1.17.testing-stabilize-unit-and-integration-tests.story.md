# Story 1.17: Test Stabilization – Unit & Integration

## Status: Draft

## Story

As a developer,
I want the unit and integration tests to be reliable and aligned with the current backend adapter and database design,
so that CI runs consistently green and we can confidently evolve features without regressions.

## Acceptance Criteria

1. Database integration tests run without native `sqlite3` worker crashes.
   - Uses in-memory (or isolated) SQLite database per test/suite.
   - Migrations are executed in test setup.
   - DB tests run serially where required.
2. Settings integration tests are aligned with `BackendAdapter` (Story 1.2/1.4).
   - Tests no longer target the legacy `SettingsAdapter` API.
   - `selectFile(options)` is mocked for Electron dialog; `keytar` is mocked for secure storage.
   - `getSettings()` test asserts merged defaults behavior per Story 1.2/1.4.
   - If `validateSettings`/`resetSettings` are required, either provide thin wrappers on `BackendAdapter` or update tests to the current behavior.
3. IPC integration tests remain passing with explicit Electron mocks and channel assertions.
4. Story 1.7 clamping rules are reflected in tests (e.g., saturation clamped to 0..3).
5. Add npm scripts to run stabilized subsets:
   - `test:integration:db`
   - `test:integration:settings`
   - `test:story:1.7`
6. Documentation updated to explain test setup (DB strategy, Electron/Keytar mocks) and how to run subsets locally and in CI.

## Tasks / Subtasks

- Database tests (JobConfiguration)
  - [ ] Switch to in-memory or unique-per-test SQLite path.
  - [ ] Ensure migrations run in `beforeAll` (or suite-level setup) and cleanup in `afterEach/afterAll`.
  - [ ] Serialize DB tests if parallelism causes contention (`--sequence` or `test.concurrent = false`).
  - [ ] Remove brittle expectations; assert concrete persisted state instead of spy-only expectations.

- Settings adapter integration tests
  - [ ] Update tests to call `BackendAdapter` API (Story 1.2/1.4) instead of legacy `SettingsAdapter`.
  - [ ] Mock `keytar` (get/set) and Electron dialog flows (`selectFile(options)`).
  - [ ] Update expectations to defaults+DB merge behavior for `getSettings()`.
  - [ ] Replace or remove expectations around deprecated methods; add thin wrappers only if needed.

- IPC and adapter wiring
  - [ ] Keep Electron IPC mocked in tests; assert handlers registration and payload validation.
  - [ ] Ensure tests don’t directly invoke native modules.

- Adapter injection for DB (to unblock 1.9 tests)
  - [ ] Extract DB access in `BackendAdapter` behind injectable interfaces (GeneratedImage, JobExecution, JobConfiguration).
  - [ ] Provide lightweight test doubles to avoid loading native `sqlite3`.
  - [ ] Unblock and enable 1.9 acceptance tests in pre-commit:
    - Manual Approve Flow (move temp → output; fallbacks; DB updates; QC approved)
    - Retry Normalization E2E (stringified values normalized → `processImage`)

- Story 1.7 alignment
  - [ ] Normalize/clamp modified processing settings in assertions (e.g., `saturation` clamped to 3).

- Retry behavior and qcReason mapping (new)
  - [ ] Unit: mock `sharp` so `trim()` throws; call `processImage` with `failRetryEnabled=true` and `failOnSteps=['trim']`; assert thrown error has `stage='trim'`.
  - [ ] Integration: mock `processImage` to throw `{ stage:'trim', message:'...' }`; run `retryExecutor` with `failOptions={ enabled:true, steps:['trim'] }`; assert DB status `retry_failed` and `qcReason='processing_failed:trim'`.
  - [ ] Integration: simulate remove.bg failures: (a) 403 auth_failed, (b) 400 unknown_foreground; assert `qcReason='processing_failed:remove_bg'` and status `retry_failed` when Fail Retry ON; assert soft-fallback (approved or continues) when OFF.
  - [ ] Unit: mock enhancement validation to throw (mock `sharp().clone().toBuffer()`); call `processImage` with `failRetryEnabled=true` and `failOnSteps=['enhancement']`; assert thrown error has `stage='enhancement'`.
  - [ ] Integration: mock `processImage` to throw `{ stage:'enhancement', message:'...' }`; run `retryExecutor` with `failOptions={ enabled:true, steps:['enhancement'] }`; assert DB status `retry_failed` and `qcReason='processing_failed:enhancement'`.
  - [ ] UI unit: for `{ qcStatus:'retry_failed', qcReason:'processing_failed:trim' }` assert:
    - `formatQcLabel` returns "Trim failed"
    - `formatQcFailureReason` returns human‑readable text
    - `FailedImagesReviewPanel` and `FailedImageReviewModal` render red failed badge with exclamation icon and mapped text.
  - [ ] Ensure `retryExecutor` initializes provider credentials (remove.bg key) from job configuration in tests; add assertion that remove.bg request includes API key header.
  - [ ] UI unit: for `{ qcStatus:'retry_failed', qcReason:'processing_failed:enhancement' }` assert label "Enhancement failed" and descriptive Failure Reason text.

- Tooling & DX
  - [ ] Add npm scripts for targeted subsets (DB, settings, story-1.7).
  - [ ] Update `tests/setup.ts` with shared mocks (keytar, Electron dialog) and DB helpers.
  - [ ] Add documentation in `docs/architecture/testing-strategy.md` for the new setup.
  - [ ] Add `test:exports` subset to pre-commit (ZIP + Excel export regressions)

## Post-1.9 Failing Tests Remediation (scope addendum)

Exclude tests that are already green and enforced by the HySky pre-commit hook. Focus only on failures introduced by Story 1.9 development work.

- Remediation scope
  - [ ] Identify and list failing suites/specs attributable to 1.9 changes (report in this story log).
  - [ ] Fix integration tests broken by DB/adapter refactors in 1.9 without changing approved behavior.
  - [ ] Restore or replace mocks/stubs removed during 1.9 if needed for isolation.
  - [ ] Ensure fixed tests run in CI locally and via HySky pre-commit without flakiness.
  - [ ] Document fixes and rationale in the change log for traceability.

## Dev Notes

- Dependencies
  - Story 1.2 (Backend Adapter & IPC bridge)
  - Story 1.3 (DB schema, migrations, models)
  - Story 1.4 (Settings UI alignment & file selection contract)
  - Story 1.7 (QC retry, clamping bounds)

- Known root causes being addressed
  - Native `sqlite3` worker crash under parallel test load.
  - Tests referring to legacy `SettingsAdapter` symbols.
  - Missing or strict expectations on OS-bound modules (keytar, dialog) without mocks.

- Execution guidance
  - Prefer `:memory:` or temp-path SQLite for isolation.
  - Run DB suites serially if needed.
  - Centralize mocks in `tests/setup.ts`.

## Testing Plan

- Commands
  - `npm run test:run -- tests/integration/database/JobConfiguration.integration.test.ts`
  - `npm run test:run -- tests/integration/api/settingsAdapter.integration.test.ts`
  - `npm run test:run -- tests/integration/api/FailedImagesReview.IPC.integration.test.ts`
  - `npm run test:e2e -- --grep "Failed Images Review|Results Gallery"`
  - `npm run test:exports` (ZIP + single/bulk job export regressions)

- Passing criteria
  - All updated integration suites green locally (no native crashes).
  - E2E unaffected and still passing.

## Risks

- Over-mocking can hide real regressions; balance mocks vs. realistic integration.
- DB test serialization may increase run time; mitigate by scoping suites.

## Change Log

| Date       | Version | Description                                 | Author |
|------------|---------|---------------------------------------------|--------|
| 2025-08-14 | 1.0     | Initial story draft (test stabilization)    | Dev    |

## QA Results

To be completed by QA upon completion.



