# Story 1.11: Provider Swap to Runware (Unified Image Inference)

## Status: Ready for Development

## Story

As a user and developer,
I want a reliable, unified image generation provider with broad model coverage (Flux, Nano Banana, and beyond),
so that generation remains stable despite third-party changes, and we can expand capabilities over time.

## Acceptance Criteria

1. Core generation path works via Runware using a single request that returns image URLs.
2. No database, IPC, or schema changes required.
3. Existing pipeline is preserved: download → optional processing → DB save → QC/metadata → final move.
4. On empty results or errors, the job fails fast with a clear user-facing message.
5. Settings include Runware-specific fields:
   - Model (freeform, default `runware:101@1`)
   - Image Dimensions (optional) — list of `widthxheight`, e.g., `1024x1024,1280x720,720x1280`, applied sequentially per generation. If omitted, we do not send width/height and rely on the provider/model default (typically square).
   - Format selector (`png` / `jpg` / `webp`), independent of post-processing convert-to-JPG/PNG (processing will not add WEBP conversion support in this story)
   - Variations count (per generation) with bounds 1–20 (default 1)
   - Advanced Controls (collapsible/hidden by default, revealed via toggle/spoiler): LoRA list; optional `checkNSFW`, optional `scheduler` (freeform), optional numeric `CFGScale`, optional numeric `steps`. If optional fields are empty, they are omitted from the request.
6. Total images per job is capped at 10,000. When user changes Generations or Variations, the other value is clamped to satisfy `generations × variations ≤ 10000`, with helper text explaining the adjustment.
7. UI hides Midjourney-specific actions (variation/upscale/pan/zoom) to avoid confusion.

## References
- Runware Image Inference API: https://runware.ai/docs/en/image-inference/api-reference
- Runware Text-to-Image: https://runware.ai/docs/en/image-inference/text-to-image
- (Context) API Frame endpoints (future alternative): https://docs.apiframe.ai/api-endpoints
- (Context) PiAPI Midjourney sunsetting: https://piapi.ai/docs/midjourney-api/penalties

## Tasks / Subtasks

- Provider adapter (minimal)
  - [x] Implement Runware adapter inside `src/producePictureModule.js` with a single POST request.
  - [x] Map fields:
    - prompt → `positivePrompt`
    - generations → sequential loop over dimensions list
    - variations → `numberResults` (1–20)
    - Image Dimensions list (optional) → when provided, split to ordered `width`/`height` per generation (sequential application); when omitted, omit width/height so provider uses model defaults.
    - Format → `outputFormat` (`png`/`jpg`/`webp`), with `outputType: "URL"`
    - Advanced: LoRA (array of `{ model, weight }` items) when provided; `checkNSFW` boolean; `scheduler` string; `CFGScale` number; `steps` number — only include fields that are set.
  - [x] Enforce total images cap: if `generations × variations > 10000`, clamp before dispatch and log the adjusted values.
  - [x] Parse `data[].imageURL`; treat empty list as failure with actionable message.
  - [x] Keep all post-download processing unchanged (convert, enhancement, trim, etc.).

- Settings (phase 1)
  - [x] Add fields in Parameters section:
    - Runware Model (freeform, default `runware:101@1`)
    - Image Dimensions (optional CSV `widthxheight` list; helper: “leave empty to use provider defaults, typically square”)
    - Format select (`png`/`jpg`/`webp`) with helper: “processing conversions support JPG/PNG only in this story”
    - Variations count (1–20, default 1) with helper showing: `Total images = Generations × Variations (cap 10,000)`
  - [x] Add Advanced Controls as a collapsible section (hidden by default, revealed via toggle/spoiler):
    - LoRA list (rows of `{ model, weight }`)
    - Optional `checkNSFW` toggle (default false)
    - Optional `scheduler` (freeform)
    - Optional numeric `CFGScale`
    - Optional numeric `steps`
  - [x] Persist all fields; only send optional ones if non-empty. Clamp invalid values and reflect clamping in UI helpers.
  - [x] Add Runware API Key to API Keys section in Settings:
    - Field label: "Runware API Key"; stored via secure storage (same mechanism as existing keys)
    - Update preload/electron types and `electronAPI` typings; expose `get/set/delete` operations like others
    - Basic validation (non-empty); helper text and external link to provider docs

- UI/UX parity
  - [x] Hide MJ-only actions in UI (variation/upscale/pan/zoom).
  - [x] Maintain current progress steps UI (Initialization → Image Generation) with same transitions.

- Errors & timeouts
  - [x] Fail fast on non-200 or empty results with clear message.
  - [x] Retain existing timeout/guard logic to avoid hangs.

- Tests
  - [x] Update stubs to match Runware response shape (URLs in `data[].imageURL`).
  - [x] Add a success-path test for URL parsing and DB save.
  - [x] Add unit tests for: dimensions parsing; variations clamping (1–20); total images cap clamping for `generations × variations ≤ 10000`.

## Dev Notes
- Reuse 80–90% of the existing pipeline; scope is limited to the provider call and request mapping.
- We are not implementing reference/guiding input images in this story; LoRA is supported as the primary model adaptation mechanism for Flux.
- Aspect ratio dropdown is replaced by explicit Image Dimensions input to avoid model-specific ratio mismatches.
- Runware image generation uses a direct (non-polling) request; we will reuse the existing “Polling Timeout” setting as an HTTP request timeout (and for image download), while ignoring the “Polling Interval” for Runware (kept for compatibility with other providers).
- Returned image count per generation may vary by model; we request `numberResults = variations` and handle fewer/more safely. Progress/UI reflects actual saved images.
- `CFGScale` and `steps` ranges are model-dependent; we won’t enforce hard max/min beyond numeric validation. Users must consult model docs for advisable ranges.
- WEBP can be selected as provider output format; we will download and store as-is. Processing conversions (e.g., convert-to-JPG/PNG) remain JPG/PNG-only in this story.

## Risks
- Cost/rate limits differ across models; clamp `numberResults` if needed.
- Invalid or extreme dimensions may fail on specific models; add minimal validation (e.g., positive integers, sane bounds).
- Model id differences may produce varied outputs; keep a safe default and let power users override.

## Change Log
| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-09-21 | 1.0     | Initial story proposal and plan      | Dev    |
| 2025-09-21 | 1.1     | Updated to use Image Dimensions, Format, mandatory LoRA; added optional checkNSFW & scheduler | Dev    |
| 2025-09-21 | 1.2     | Advanced Controls set to collapsible/hidden with toggle/spoiler | Dev    |
| 2025-09-21 | 1.3     | Documented direct (non-polling) image request and timeout reuse | Dev    |
| 2025-09-21 | 1.4     | Added Variations count, total images cap (10,000), and clamping rules | Dev    |
| 2025-09-21 | 1.5     | Marked Image Dimensions as optional with provider-default fallback | Dev    |
| 2025-09-21 | 1.6     | Added optional CFGScale and steps (numeric, model-dependent) | Dev    |
| 2025-09-21 | 1.7     | Added WEBP to output formats; conversions remain JPG/PNG-only in processing | Dev    |
| 2025-09-21 | 1.8     | Added Runware API Key to Settings (secure storage + typings updates) | Dev    |
