# Story 1.20.1: Fix E2E Test Failures

## Status: In Progress

## Story

**As a** developer,
**I want** all E2E tests to pass reliably,
**so that** releases are not blocked by test failures and we can proceed with Story 1.21 (distribution and application packaging).

## Acceptance Criteria

1. **All E2E tests pass consistently**:
   - All 92 E2E tests pass on chromium (manual/workflow_dispatch runs)
   - All E2E tests pass on all browsers (nightly scheduled runs)
   - Tests complete in reasonable time (< 25 minutes for full suite)
   - No flaky tests (tests that pass/fail intermittently)

2. **Test reliability**:
   - Tests handle timing issues properly (appropriate waits, timeouts)
   - Tests are resilient to CI environment differences
   - Tests properly clean up after themselves
   - Tests don't interfere with each other when run in parallel

3. **Documentation**:
   - Root causes of failures are documented
   - Fixes are documented with rationale
   - Any test infrastructure improvements are documented

## Current State

**Test Results (as of Story 1.20 completion)**:
- **Total tests**: 92
- **Passed**: 49
- **Failed**: 43
- **Skipped**: 1
- **Flaky**: 1
- **Execution time**: ~20 minutes (optimized from 35+ minutes)

**Optimizations Applied (Story 1.20)**:
- Chromium-only for manual/workflow_dispatch triggers (~3x faster)
- 2 workers instead of 1 for better parallelization (~2x faster)
- Full cross-browser testing preserved for scheduled nightly runs

**Failure Analysis Needed**:
- Common failure patterns (e.g., element not found, timing issues)
- Test categories affected (platform compatibility, workflows, etc.)
- CI vs local environment differences
- Root cause identification for each failure category

## Scope

- **In scope**:
  - Investigate and fix all 43 failing E2E tests
  - Fix the 1 flaky test
  - Address timing/race condition issues
  - Improve test reliability and resilience
  - Ensure tests work in both local and CI environments
  - Verify fixes don't break passing tests

- **Out of scope**:
  - Adding new E2E tests (belongs in feature stories)
  - Performance optimization beyond what's already done (Story 1.20)
  - Unit/integration test fixes (separate concern)

## Tasks / Subtasks

- **Investigation Phase**
  - [x] **Categorize failing tests**: Group failures by common patterns (element not found, timing, app not loading, etc.)
  - [x] **Identify root causes**: Determine if failures are due to:
    - Timing/race conditions
    - Missing test data or setup
    - App not loading properly in CI
    - Selector issues (test IDs, class names changed)
    - Environment differences (CI vs local)
  - [x] **Document failure patterns**: Create a summary of failure categories with examples
  - [x] **Prioritize fixes**: Identify which fixes will resolve multiple failures (high-impact fixes first)

- **Fix Implementation**
  - [x] **Fix timing issues**: Add appropriate waits, increase timeouts, use proper Playwright wait strategies
  - [x] **Fix element selectors**: Update selectors if UI changed, ensure test IDs are present
  - [ ] **Fix test setup/teardown**: Ensure proper test isolation and cleanup
  - [x] **Fix app loading issues**: Investigate why `app-root` and other elements aren't found
  - [ ] **Fix flaky test**: Identify and fix the flaky test (electron-app.e2e.test.js:98)
  - [ ] **Verify fixes locally**: Run full E2E suite locally to verify fixes
  - [ ] **Verify fixes in CI**: Trigger E2E workflow to verify fixes work in CI environment

- **Validation**
  - [ ] **Full test suite passes**: All 92 tests pass on chromium
  - [ ] **Full cross-browser suite passes**: All tests pass on chromium, firefox, webkit (nightly run)
  - [ ] **No regressions**: Verify previously passing tests still pass
  - [ ] **Performance maintained**: Ensure execution time remains reasonable (< 25 min for full suite)

- **Documentation**
  - [ ] **Document fixes**: Update test files with comments explaining fixes
  - [ ] **Update testing strategy**: Document any test infrastructure improvements
  - [ ] **Create troubleshooting guide**: Add common E2E test failure patterns to testing-strategy.md

## Developer Notes

- **Reference**: `docs/architecture/testing-strategy.md` for E2E testing guidelines
- **Test files location**: `tests/e2e/`
- **Playwright config**: `playwright.config.ts`
- **CI workflow**: `.github/workflows/e2e-tests.yml`

- **Common Failure Patterns (Initial Observations)**:
  - Element not found: `getByTestId('app-root')` and other elements
  - App not loading: Tests fail because app doesn't load in time
  - Timing issues: Race conditions between test steps
  - Test isolation: Tests interfering with each other

- **Test Categories Affected**:
  - Platform compatibility tests (`tests/e2e/cross-platform/platform-compatibility.e2e.test.ts`)
  - Basic app functionality tests (`tests/e2e/workflows/basic-app-functionality.e2e.test.ts`)
  - Failed images review tests (`tests/e2e/workflows/failed-images-review.e2e.test.ts`)
  - Results gallery tests (`tests/e2e/workflows/results-gallery.e2e.test.ts`)
  - Bulk rerun regression tests (`tests/e2e/workflows/bulk-rerun-regression.e2e.test.ts`)
  - Single job rerun regression tests (`tests/e2e/workflows/single-job-rerun-regression.e2e.test.ts`)
  - Single job run regression tests (`tests/e2e/workflows/single-job-run-regression.e2e.test.ts`)
  - Settings configuration tests (`tests/e2e/workflows/settings-configuration.e2e.test.ts`)

- **Investigation Approach**:
  1. Run tests locally to reproduce failures
  2. Check Playwright HTML report for detailed failure information
  3. Identify common patterns across failures
  4. Fix high-impact issues first (ones that affect multiple tests)
  5. Iterate: fix → test → verify

- **Playwright Best Practices**:
  - Use `page.waitForLoadState()` for page loads
  - Use `page.waitForSelector()` for dynamic content
  - Use `expect(locator).toBeVisible()` with appropriate timeouts
  - Avoid `page.waitForTimeout()` (use proper waits instead)
  - Use `test.beforeEach()` for consistent test setup
  - Use `test.afterEach()` for cleanup

## Testing Plan

- **Local Validation**:
  - Run full E2E suite: `npm run test:e2e -- --project=chromium`
  - Verify all 92 tests pass
  - Check for any flaky tests (run multiple times)

- **CI Validation**:
  - Trigger E2E workflow manually: `gh workflow run "E2E Tests"`
  - Verify all tests pass in CI environment
  - Check execution time is reasonable

- **Cross-Browser Validation**:
  - Wait for nightly scheduled run or trigger manually
  - Verify all tests pass on chromium, firefox, webkit

## Risks

- **Fixes may break passing tests**: Mitigated by running full suite after each fix
- **Some failures may be environment-specific**: Mitigated by testing in both local and CI
- **Fixes may require test infrastructure changes**: Document and review before implementing

## Dependencies

- **Story 1.20**: Setup Quality Gates & CI (must be complete; E2E optimizations already applied)
- **Story 1.21**: Distribution Application Packaging (blocked until E2E tests pass)

## Related Requirements

- **NFR8**: Testing strategy adherence (E2E tests must be reliable)
- **Release readiness**: E2E test failures block releases

## File List

- `tests/e2e/workflows/single-job-rerun-regression.e2e.test.ts` - Fixed beforeEach timeout issues
- `tests/e2e/workflows/basic-app-functionality.e2e.test.ts` - Fixed StatusBadge tests and app-root selector
- `tests/e2e/workflows/failed-images-review.e2e.test.ts` - Fixed dashboard loading wait strategy
- `tests/e2e/workflows/electron-app.e2e.test.js` - Electron launch tests (needs investigation)
- `tests/e2e/cross-platform/platform-compatibility.e2e.test.ts` - May need similar fixes
- `tests/e2e/workflows/results-gallery.e2e.test.ts` - May need similar fixes
- `tests/e2e/workflows/bulk-rerun-regression.e2e.test.ts` - May need similar fixes
- `tests/e2e/workflows/single-job-run-regression.e2e.test.ts` - May need similar fixes
- `tests/e2e/workflows/settings-configuration.e2e.test.ts` - May need similar fixes
- `playwright.config.ts` - Playwright configuration (may need adjustments)
- `docs/architecture/testing-strategy.md` - Testing strategy documentation (to be updated)

## Dev Agent Record

### Failure Analysis (GitHub Actions Run #20388641720)

**Failure Categories Identified:**

1. **Element Visibility Failures (Most Common)**
   - Pattern: `expect(locator).toBeVisible()` failures
   - Affected tests: StatusBadge tests, Failed Images Review tests, many workflow tests
   - Root cause: Elements not rendering or not appearing within timeout period
   - Examples:
     - `[data-testid="status-badge-failed"]` not found
     - `[data-testid="status-badge-retry-failed"]` not found
     - `button:has-text("Start Job")` timing out in beforeEach hooks

2. **Timeout Errors in beforeEach Hooks**
   - Pattern: `Test timeout of 30000ms exceeded while running "beforeEach" hook`
   - Affected: `single-job-rerun-regression.e2e.test.ts` and others
   - Root cause: `page.waitForSelector('button:has-text("Start Job")')` timing out
   - Impact: Prevents entire test suites from running

3. **Electron Process Launch Failures**
   - Pattern: `Error: Process failed to launch!` / `Error: electron.launch: Process failed to launch!`
   - Affected: `electron-app.e2e.test.js` tests
   - Root cause: Electron app not launching in CI environment (likely headless/display issues)

4. **CSS Assertion Failures**
   - Pattern: `expect(locator).toHaveCSS(expected) failed`
   - Affected: StatusBadge styling tests
   - Root cause: Elements not visible, so CSS checks fail

**Prioritized Fix Order:**
1. Fix beforeEach timeout issues (blocks entire test suites)
2. Fix element visibility/selector issues (affects most tests)
3. Fix Electron launch issues (affects packaged app tests)
4. Fix CSS assertion issues (depends on visibility fixes)

### Agent Model Used
- Claude Sonnet 4.5

### Debug Log References
- GitHub Actions Run: https://github.com/ascensum/gen-image-factory/actions/runs/20388641720
- Test results analyzed from CI logs

### Completion Notes

**Fixes Applied (2025-01-24):**

1. **Fixed beforeEach timeout issues in `single-job-rerun-regression.e2e.test.ts`**:
   - Added `waitForLoadState('networkidle')` to ensure page is fully loaded
   - Improved wait strategy to handle both home screen and dashboard scenarios
   - Added fallback selectors and increased timeout to 15 seconds
   - Added small delay to ensure React components are fully rendered

2. **Fixed StatusBadge test visibility issues in `basic-app-functionality.e2e.test.ts`**:
   - Improved beforeEach to wait for export harness with longer timeout (15s)
   - Added `waitForLoadState('networkidle')` before waiting for elements
   - Added delay to ensure status badges are rendered before assertions

3. **Fixed app-root test ID issue** (in multiple files):
   - Replaced non-existent `app-root` test ID check with actual visible content check
   - Uses flexible selector that works with actual app structure
   - Fixed in: `platform-compatibility.e2e.test.ts`, `basic-app-functionality.e2e.test.ts`

4. **Fixed failed-images-review test setup**:
   - Improved beforeEach to check if already on dashboard before navigating
   - Added flexible wait strategy using `Promise.race()` for multiple possible selectors
   - Increased timeouts and added render delay

**Files Modified:**
- `tests/e2e/workflows/single-job-rerun-regression.e2e.test.ts`
- `tests/e2e/workflows/basic-app-functionality.e2e.test.ts`
- `tests/e2e/workflows/failed-images-review.e2e.test.ts`
- `tests/e2e/cross-platform/platform-compatibility.e2e.test.ts`

**CI Test Run Analysis (Run #20392316077 - BEFORE fixes committed):**

**Current CI Results (old code):**
- **Total tests**: 92
- **Passed**: 48
- **Failed**: 43
- **Skipped**: 1
- **Execution time**: 19.1 minutes

**Comparison with Previous Baseline:**
- Previous: 49 passed, 43 failed, 1 skipped
- Current: 48 passed, 43 failed, 1 skipped
- **Note**: Slight regression (1 less passing), but this is expected variance - same failure count

**Failure Categories Still Present (in old code):**
1. **Platform compatibility tests** - Still using `getByTestId('app-root')` (will be fixed after commit)
2. **StatusBadge tests** - Still failing visibility checks (will be fixed after commit)
3. **Failed images review** - Still failing at beforeEach (will be fixed after commit)
4. **Electron launch failures** - Still present (needs separate investigation)

**Next Steps:**
1. **Commit and push fixes** - Changes are currently only local
2. **Re-run CI** - Verify fixes work in CI environment
3. **Address remaining failures** - Electron launch issues and any other failures

## Change Log

| Date       | Version | Description                                | Author |
|------------|---------|--------------------------------------------|--------|
| 2025-01-XX | 1.0     | Initial story draft (E2E test fixes)      | Dev    |
| 2025-01-24 | 1.1     | Failure analysis from GitHub Actions run   | Dev    |
