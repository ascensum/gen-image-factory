# Story 1.19: Acceptance Fixes & Stabilization

## Status
Draft

## Story
As a product owner,
I want the acceptance-test issues fixed and critical flows stabilized,
so that the app behaves predictably and honors user settings across all primary scenarios.

## Acceptance Criteria
1. Blocking and Major issues listed below are resolved with verifiable behavior in the UI and filesystem.
2. All fixes include targeted tests where feasible and manual verification notes.
3. No regressions in working PNG generation, queueing, exports, settings persistence, and UI responsiveness.
4. Logged errors are actionable and do not contain sensitive data.

## Issues To Resolve (Confirmed)

### Blocking
- JPG/JPEG/WEBP saved as .png despite provider generating correct formats
  - Accept: Correct extension preserved and saved without unintended conversion.

### Major
- Output path ignored for standard runs and reruns (Desktop fallback appears); Retry uses configured path correctly
  - Accept: All flows honor configured generated path; fallback only on explicit error with visible warning.
- Date filter logic incorrect when only start date is set
  - Accept: Start-only filters [start, now]; End-only filters [min, end]; combined works.
- Orphaned "Running" jobs on network loss during generation stage
  - Accept: Jobs transition to Failed or are recoverable; no stuck "Running" entries.
- Orphaned job after app quit during active run
  - Accept: On startup, any "Running" without worker becomes Failed with Retry available.
- "Has pending retries" filter does nothing in Job Management
  - Accept: Shows only parent jobs awaiting retry spawn when checked.
- Remove.bg size ignored (uses "auto" regardless of selected value across Settings, Single Job Edit, Retry custom)
  - Accept: Selected size is honored end-to-end.
- Image Gallery → Single Image Modal "Processing" tab not reflecting latest edits from Edit modal
  - Accept: Processing tab shows up-to-date processing settings after edits, without reopening the modal. Also validate the same in Failed Images Review Single Image Modal.

### Minor / UX
- Single Job View export uses old UI instead of new export modal
  - Accept: Uses same modal flow as Job Management Export Selected; single-job exports .xlsx.
- QC Retry (custom) causes flashing; also when "add metadata" is selected
  - Accept: Smooth state update; no visible flicker.
- Retry modal (Failed Image Review): Remove.bg size options incomplete
  - Accept: Options match Settings dropdown exactly.
- Retry modal (Failed Image Review): Enhancement controls are text fields instead of sliders
  - Accept: Uses same slider components as Settings for sharpening/saturation.
- PNG conversion quality control is misleading
  - Accept: Hide or disable PNG quality input when Convert Format = PNG; provide brief helper text if needed.

### Needs Investigation
- Intermittent backend error on app launch
  - Accept: Root-caused and resolved; clean cold start.

### Not in Scope / Clarified
- Retry-on-connectivity-restore partially works before generation stage; tracked by orphaning during generation.
- API quota/429 handling not required for this story unless requirements change.
- Backup manager not a requirement; out of scope.

## Tasks / Subtasks
- [x] Fix format/extension handling so JPG/JPEG/WEBP are saved correctly
  - [x] Audit download/save pipeline and remove forced .png conversions
  - [ ] Add tests for extension preservation and content type
- [x] Honor configured output paths for standard runs and reruns
  - [x] Unify path resolver across normal runs and retries
  - [ ] Show explicit warning only on write failures; avoid silent Desktop fallback
- [ ] Correct date filter behavior for start-only and end-only
  - [ ] Update filter predicates and add unit test coverage
- [ ] Handle network loss during generation without orphaned "Running" jobs
  - [ ] Add timeout/error transition to Failed with Retry
  - [ ] Reconcile UI polling to reflect final state
- [ ] On app startup, reconcile orphaned "Running" jobs to Failed
  - [ ] Implement startup reconciliation and add migration if needed
- [ ] Implement "Has pending retries" filter logic
  - [ ] Wire predicate to show parent jobs awaiting retry spawn
- [ ] Ensure Remove.bg size is honored everywhere
  - [ ] Verify param mapping from UI to backend; fix enum mapping
- [ ] Unify Single Job View export UI with new modal
  - [ ] Use same modal; target single .xlsx export
- [ ] Eliminate QC Retry flicker by reducing unnecessary re-renders
  - [ ] Replace full-list refresh with local state patch
- [ ] Complete Remove.bg size options in Retry modal
  - [ ] Mirror Settings dropdown values
- [ ] Replace text fields with sliders for sharpening/saturation in Retry modal
  - [ ] Reuse Settings slider components
- [ ] Investigate backend error at app launch and fix root cause

## Definition of Done
- [ ] All Blocking and Major issues resolved and verified manually.
- [ ] Unit/Integration/E2E tests updated where feasible.
- [ ] No sensitive data in logs; errors are actionable.
- [ ] Lint/tests green.

## Risks
- Fixes may touch shared pipelines (save paths, job state), risking regressions—guard with tests and staged commits.

## Story Points
5

## Backlog Notes
- Consider adding 429/backoff handling in a future story if needed.
