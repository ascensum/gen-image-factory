# Story 1.19: Acceptance Fixes & Stabilization

## Status
Draft

## Story
As a product owner,
I want the acceptance-test issues fixed and critical flows stabilized,
so that the app behaves predictably and honors user settings across all primary scenarios.

## Acceptance Criteria
1. Blocking and Major issues listed below are resolved with verifiable behavior in the UI and filesystem.
2. All fixes include targeted tests where feasible and manual verification notes.
3. No regressions in working PNG generation, queueing, exports, settings persistence, and UI responsiveness.
4. Logged errors are actionable and do not contain sensitive data.

## Issues To Resolve (Confirmed)

### Scope Additions Implemented
- As-run configuration snapshots:
  - Execution-level `configurationSnapshot` is captured at job start (excluding API keys).
  - Single Job View Overview shows snapshot settings for the execution.
  - Image modals (“Processing” tab) prefer per-image `processingSettings` when a retry with custom settings was used; otherwise, they show the execution snapshot to reflect as-run settings.
- Runware Advanced gating:
  - A `runwareAdvancedEnabled` flag controls inclusion of advanced parameters (CFG Scale, Steps, Scheduler, NSFW, LoRA).
  - When disabled, advanced parameters are removed on save and sanitized at execution time and in reruns.
  - UI hides the Runware Advanced section if nothing is enabled.
- Local file URL handling:
  - Introduced `buildLocalFileUrl` to standardize `local-file:///` URLs for cross-platform rendering of images in the renderer process.
- Image conversion and quality model:
  - Added WEBP conversion end-to-end (Settings, Single Job View Edit, Failed Images Review Retry, processing pipeline, snapshots, and UI display).
  - PNG conversion is kept lossless (no PNG quality control anywhere).
  - JPG and WEBP have independent quality controls. Defaults are JPG=85, WEBP=85 when not set by user.
  - UI behavior:
    - Settings: Convert Format includes PNG/JPG/WEBP. Show JPG Quality only when JPG selected; show WebP Quality only when WEBP selected.
    - Single Job View Edit: same controls and conditional visibility as Settings.
    - Failed Images Review Retry (custom): same controls and conditional visibility; values are persisted and applied on retry.
  - Display behavior:
    - Image modals’ “Processing” tab only shows JPG Quality if convert=JPG and Image Convert=ON; only shows WebP Quality if convert=WEBP and Image Convert=ON; no PNG quality is shown.
    - Single Job View “Overview”:
      - Image Settings: “Format” rendered uppercase; “Convert to JPG” removed.
      - Processing Options: “Convert Format” shows PNG/JPG/WEBP; JPG/WebP quality shown only when applicable; PNG Quality removed; “Trim Transparent” shows “Not applied (Remove Background OFF)” when removal is OFF.
  - Retry fixes:
    - Original-settings retry now honors convertToWebp/webpQuality (no accidental JPG).
    - Custom retry with metadata and changed WebP quality uses WEBP with the chosen quality; final extension and snapshot reflect WEBP settings.

### Blocking
- JPG/JPEG/WEBP saved as .png despite provider generating correct formats
  - Accept: Correct extension preserved and saved without unintended conversion.

### Major
- Output path ignored for standard runs and reruns (Desktop fallback appears); Retry uses configured path correctly
  - Accept: All flows honor configured generated path; fallback only on explicit error with visible warning.
- Date filter logic incorrect when only start date is set
  - Accept: Start-only filters [start, now]; End-only filters [min, end]; combined works.
- Orphaned "Running" jobs on network loss during generation stage
  - Accept: Jobs transition to Failed or are recoverable; no stuck "Running" entries.
- Orphaned job after app quit during active run
  - Accept: On startup, any "Running" without worker becomes Failed with Retry available.
- "Has pending retries" filter does nothing in Job Management
  - Accept: Shows only parent jobs awaiting retry spawn when checked.
- Remove.bg size ignored (uses "auto" regardless of selected value across Settings, Single Job Edit, Retry custom)
  - Accept: Selected size is honored end-to-end.
- Image Gallery → Single Image Modal "Processing" tab not reflecting latest edits from Edit modal
  - Accept: Processing tab shows up-to-date processing settings after edits, without reopening the modal. Also validate the same in Failed Images Review Single Image Modal.

### Minor / UX
- Single Job View export uses old UI instead of new export modal
  - Accept: Uses same modal flow as Job Management Export Selected; single-job exports .xlsx.
- QC Retry (custom) causes flashing; also when "add metadata" is selected
  - Accept: Smooth state update; no visible flicker.
- Retry modal (Failed Image Review): Remove.bg size options incomplete
  - Accept: Options match Settings dropdown exactly.
- Retry modal (Failed Image Review): Enhancement controls are text fields instead of sliders
  - Accept: Uses same slider components as Settings for sharpening/saturation.
- PNG conversion quality control is misleading
  - Accept: Hide or disable PNG quality input when Convert Format = PNG; provide brief helper text if needed.

### New
- WebP support and trimming alignment
  - Add conversion to .webp via sharp; reuse PNG Quality field as WebP Quality (rename label to “WebP Quality” when WebP selected).
  - Ensure Remove Background + Trim Transparent behaviors remain gated by Remove.bg = ON (no provider-specific alpha-trim).

### Needs Investigation
- Intermittent backend error on app launch
  - Accept: Root-caused and resolved; clean cold start.

### Not in Scope / Clarified
- Retry-on-connectivity-restore partially works before generation stage; tracked by orphaning during generation.
- API quota/429 handling not required for this story unless requirements change.
- Backup manager not a requirement; out of scope.

## Tasks / Subtasks
- [x] Fix format/extension handling so JPG/JPEG/WEBP are saved correctly
  - [x] Audit download/save pipeline and remove forced .png conversions
  - [ ] Add tests for extension preservation and content type
- [x] Honor configured output paths for standard runs and reruns
  - [x] Unify path resolver across normal runs and retries
  - [ ] Show explicit warning only on write failures; avoid silent Desktop fallback
- [x] Correct date filter behavior for start-only and end-only
  - [ ] Update filter predicates and add unit test coverage
- [x] Handle network loss during generation without orphaned "Running" jobs
  - [x] Add timeout/error transition to Failed with Retry
  - [x] Reconcile UI polling to reflect final state
- [x] On app startup, reconcile orphaned "Running" jobs to Failed
  - [x] Implement startup reconciliation and add migration if needed
- [ ] Implement "Has pending retries" filter logic
  - [ ] Wire predicate to show parent jobs awaiting retry spawn
- [x] Ensure Remove.bg size is honored everywhere
  - [x] Verify param mapping from UI to backend; fix enum mapping
- [ ] Unify Single Job View export UI with new modal
  - [ ] Use same modal; target single .xlsx export
- [ ] Eliminate QC Retry flicker by reducing unnecessary re-renders
  - [ ] Replace full-list refresh with local state patch
- [x] Complete Remove.bg size options in Retry modal
  - [x] Mirror Settings dropdown values
- [ ] Replace text fields with sliders for sharpening/saturation in Retry modal
  - [ ] Reuse Settings slider components
- [ ] Investigate backend error at app launch and fix root cause
 
### New (UI/state consistency follow-ups)
- [ ] Unify image status labels between Single Job View, header status badge, and Image tab filters
  - [ ] Ensure identical status mapping/normalization across components
  - [ ] Verify filters use the same normalized set and labels
  - [ ] Update header statistics label text to match list/badges
 
### New (Retry behavior customization)
- [x] Add "Fail Retry" toggle to "Retry with custom options" modal
  - [x] When OFF: keep current defaults (Remove.bg soft, Trim hard, Convert/Save hard, Metadata soft, Enhancement soft except encode failures)
  - [x] When ON: show multi-select for steps that should hard-fail retry (Remove.bg, Trim, Enhancement, Convert/Save, Metadata)
  - [x] When ON and no steps selected: all steps are soft-fail (user responsibility)
- [x] Wire retry executor to respect selected fail-on steps
  - [x] Remove.bg: if selected, mark failed_retry on error/timeout; else soft-fail (continue)
  - [x] Trim: if selected, failed_retry on error; else soft-fail (continue)
  - [x] Enhancement: if selected, validate post-enhancement via sharpInstance.clone().toBuffer(); on error → failed_retry "Enhancement failed"; if not selected, skip enhancement on error (soft)
  - [x] Convert/Save: if selected, failed_retry on encode/write/move error; else soft-fail (continue)
  - [x] Metadata: if selected, failed_retry on error; else soft-fail (continue)
- [x] Badge/Reason mapping
  - [x] Ensure failed_retry shows step-specific reason label (e.g., "Enhancement failed", "Metadata failed")
  - [x] Export reason remains compatible with existing qcReason mappings
  
### Completed: WebP and Processing UX
- [x] Add WebP conversion via sharp; introduce WebP Quality (1–100), default 85
- [x] Keep PNG conversion lossless; remove PNG Quality controls from UI and displays
- [x] Surface WEBP/JPG quality conditionally in Settings, Single Job View Edit, Retry modal
- [x] Fix retry flows to respect WEBP conversion/quality; ensure snapshots and modals show correct values
- [x] Add qcReason mapping and UI labels for trim failures (`processing_failed:trim`)
 - [x] Single Job View: Images tab badges use qcReason labels (e.g., "Metadata failed"); dropdown filter supports specific qcReason categories
 - [x] Single Job View: Generated Images Summary label changed from "QC Failed" to "Failed Processing"

### Completed: Retry failure handling (retry_failed)
- [x] Map Convert hard-fails to `processing_failed:convert`
- [x] Map Save/move hard-fails to `processing_failed:save_final`
- [x] Map Metadata hard-fails to `processing_failed:metadata` (with heuristic fallback when stage is missing); UI badge shows “Metadata failed”
- [x] Preserve original source during retry processing (`preserveInput=true` in `processImage`)
- [x] Add deletion guard: delete source only if it lives under temp/generated and differs from final
- [x] Wrap long Failure Reason text in Failed Image Review modal (no overflow)
- [x] Badges: show “Conversion failed”/“Save failed” based on qcReason; consistent red styling
- [x] Single Job View Images tab: add filters “Failed (All)”, “Failed – QC”, “Failed – Technical”, keep per‑reason filters

### Implemented (Out-of-scope but completed in 1.19)
- [x] Persist execution-level configuration snapshots and surface in UI (Single Job View Overview, Image Modals Processing)
- [x] Prefer per-image `processingSettings` only when retry customized values
- [x] Gate Runware Advanced by `runwareAdvancedEnabled` across Settings, Edit modal, backend saves, rerun execution
- [x] Standardize local file URLs with `buildLocalFileUrl` for renderer image loads
 
## Recent fixes (Failed job handling and paths)
- Local-file URL 404s on macOS:
  - Main-process protocol handler now normalizes to `local-file:///<absolute-path>` and, on macOS, corrects lowercased `"/users/..."` to `"/Users/..."` before checking the filesystem. This fixes `net::ERR_FILE_NOT_FOUND` for URLs like `local-file://users/...`.
- Retry removing the final file after move:
  - In `RetryExecutor.runPostProcessing`, added a guard to delete the original only when `sourcePath !== finalOutputPath`. Previously, if both resolved to the same location, the just-moved file could be deleted, causing gallery/modal 404s after retry.
  - Result: retried images (e.g., IDs 2577/2578, job 817) now appear reliably in Gallery and Modals without missing files.
 - Retry Convert/Save soft‑fallback (locked output directory):
  - When Fail Retry is OFF and the move to final output fails (e.g., permissions/locked path), the executor now falls back to the original source path instead of throwing. We set `processedImagePath/newPath/finalImagePath` to the source, skip deletion of the source, and continue approving.
  - Result: retried images still display in Gallery/Modals (no 404), and the UI remains consistent even under output directory write denials.

### Recent fixes (Retry failure handling – retry_failed)
- Consistent qcReason mapping for Convert/Save:
  - Hard-fail on encode/write now maps to `processing_failed:convert`.
  - Hard-fail on final move (e.g., EACCES/locked output) maps to `processing_failed:save_final`.
  - UI badges render as “Conversion failed” / “Save failed”; filters pick them up by reason.
- Metadata retry failures:
  - When “Fail Retry = ON” and “Metadata” selected, connection/errors map to `processing_failed:metadata`. If upstream didn’t tag a stage, a safe fallback inspects the error and maps accordingly.
  - UI badge renders “Metadata failed”; Failure Reason shows metadata-specific text.
- Preserve original source during retry processing:
  - `processImage` now supports `preserveInput=true` to skip input deletion.
  - Retry path passes `preserveInput`, preventing delayed disappearance after failures.
- Safe deletion guard:
  - Original file is deleted only if it resides inside the temp/generated directory and differs from final; otherwise deletion is skipped.
- Failure Reason display:
  - Long backend error strings are wrapped in the red “Failure reason” box in Failed Image Review modal to avoid overflow.
- Single Job View Images tab filters:
  - Added “Failed (All)”, “Failed – QC”, and “Failed – Technical”.
  - Per-reason dynamic filters remain (e.g., `processing_failed:metadata`, `processing_failed:convert`).

### Recent fixes (UI consistency)
- Images filter dropdown (Single Job View):
  - De-duplicated dynamic entries when multiple qcReasons share the same visible label (e.g., avoid double “QC Failed”).
- Overview → Generated Images Summary:
  - “Failed Processing” count now includes both `qc_failed` and `retry_failed`. If image list isn’t loaded yet, falls back to stored execution statistics to keep initial render correct.

### Planned enhancements
- Excel export: include Job Label/Name and Execution ID columns to simplify filtering by job when exporting multiple jobs together.

## Definition of Done
- [ ] All Blocking and Major issues resolved and verified manually.
- [ ] Unit/Integration/E2E tests updated where feasible.
- [ ] No sensitive data in logs; errors are actionable.
- [ ] Lint/tests green.

## Risks
- Fixes may touch shared pipelines (save paths, job state), risking regressions—guard with tests and staged commits.

## Story Points
5

## Backlog Notes
- Consider adding 429/backoff handling in a future story if needed.
