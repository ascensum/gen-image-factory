# Story 1.19: Acceptance Fixes & Stabilization

## Status
Draft

## Story
As a product owner,
I want the acceptance-test issues fixed and critical flows stabilized,
so that the app behaves predictably and honors user settings across all primary scenarios.

## Acceptance Criteria
1. Blocking and Major issues listed below are resolved with verifiable behavior in the UI and filesystem.
2. All fixes include targeted tests where feasible and manual verification notes.
3. No regressions in working PNG generation, queueing, exports, settings persistence, and UI responsiveness.
4. Logged errors are actionable and do not contain sensitive data.

## Issues To Resolve (Confirmed)

### Scope Additions Implemented
- As-run configuration snapshots:
  - Execution-level `configurationSnapshot` is captured at job start (excluding API keys).
  - Single Job View Overview shows snapshot settings for the execution.
  - Image modals (“Processing” tab) prefer per-image `processingSettings` when a retry with custom settings was used; otherwise, they show the execution snapshot to reflect as-run settings.
- Runware Advanced gating:
  - A `runwareAdvancedEnabled` flag controls inclusion of advanced parameters (CFG Scale, Steps, Scheduler, NSFW, LoRA).
  - When disabled, advanced parameters are removed on save and sanitized at execution time and in reruns.
  - UI hides the Runware Advanced section if nothing is enabled.
- Local file URL handling:
  - Introduced `buildLocalFileUrl` to standardize `local-file:///` URLs for cross-platform rendering of images in the renderer process.
- Image conversion and quality model:
  - Added WEBP conversion end-to-end (Settings, Single Job View Edit, Failed Images Review Retry, processing pipeline, snapshots, and UI display).
  - PNG conversion is kept lossless (no PNG quality control anywhere).
  - JPG and WEBP have independent quality controls. Defaults are JPG=85, WEBP=85 when not set by user.
  - UI behavior:
    - Settings: Convert Format includes PNG/JPG/WEBP. Show JPG Quality only when JPG selected; show WebP Quality only when WEBP selected.
    - Single Job View Edit: same controls and conditional visibility as Settings.
    - Failed Images Review Retry (custom): same controls and conditional visibility; values are persisted and applied on retry.
  - Display behavior:
    - Image modals’ “Processing” tab only shows JPG Quality if convert=JPG and Image Convert=ON; only shows WebP Quality if convert=WEBP and Image Convert=ON; no PNG quality is shown.
    - Single Job View “Overview”:
      - Image Settings: “Format” rendered uppercase; “Convert to JPG” removed.
      - Processing Options: “Convert Format” shows PNG/JPG/WEBP; JPG/WebP quality shown only when applicable; PNG Quality removed; “Trim Transparent” shows “Not applied (Remove Background OFF)” when removal is OFF.
  - Retry fixes:
    - Original-settings retry now honors convertToWebp/webpQuality (no accidental JPG).
    - Custom retry with metadata and changed WebP quality uses WEBP with the chosen quality; final extension and snapshot reflect WEBP settings.

### Blocking
- JPG/JPEG/WEBP saved as .png despite provider generating correct formats
  - Accept: Correct extension preserved and saved without unintended conversion.

### Major
- Output path ignored for standard runs and reruns (Desktop fallback appears); Retry uses configured path correctly
  - Accept: All flows honor configured generated path; fallback only on explicit error with visible warning.
- Date filter logic incorrect when only start date is set
  - Accept: Start-only filters [start, now]; End-only filters [min, end]; combined works.
- Orphaned "Running" jobs on network loss during generation stage
  - Accept: Jobs transition to Failed or are recoverable; no stuck "Running" entries.
- Orphaned job after app quit during active run
  - Accept: On startup, any "Running" without worker becomes Failed with Retry available.
- "Has pending retries" filter does nothing in Job Management
  - Accept: Shows only parent jobs awaiting retry spawn when checked.
- Remove.bg size ignored (uses "auto" regardless of selected value across Settings, Single Job Edit, Retry custom)
  - Accept: Selected size is honored end-to-end.
- Image Gallery → Single Image Modal "Processing" tab not reflecting latest edits from Edit modal
  - Accept: Processing tab shows up-to-date processing settings after edits, without reopening the modal. Also validate the same in Failed Images Review Single Image Modal.

### Minor / UX
- Single Job View export uses old UI instead of new export modal
  - Accept: Uses same modal flow as Job Management Export Selected; single-job exports .xlsx.
- QC Retry (custom) causes flashing; also when "add metadata" is selected
  - Accept: Smooth state update; no visible flicker.
- Retry modal (Failed Image Review): Remove.bg size options incomplete
  - Accept: Options match Settings dropdown exactly.
- Retry modal (Failed Image Review): Enhancement controls are text fields instead of sliders
  - Accept: Uses same slider components as Settings for sharpening/saturation.
- PNG conversion quality control is misleading
  - Accept: Hide or disable PNG quality input when Convert Format = PNG; provide brief helper text if needed.

### New
- WebP support and trimming alignment
  - Add conversion to .webp via sharp; reuse PNG Quality field as WebP Quality (rename label to “WebP Quality” when WebP selected).
  - Ensure Remove Background + Trim Transparent behaviors remain gated by Remove.bg = ON (no provider-specific alpha-trim).

### Needs Investigation
- Intermittent backend error on app launch
  - Accept: Root-caused and resolved; clean cold start.

### Not in Scope / Clarified
- Retry-on-connectivity-restore partially works before generation stage; tracked by orphaning during generation.
- API quota/429 handling not required for this story unless requirements change.
- Backup manager not a requirement; out of scope.

## Tasks / Subtasks
- [x] Fix format/extension handling so JPG/JPEG/WEBP are saved correctly
  - [x] Audit download/save pipeline and remove forced .png conversions
  - [ ] Add tests for extension preservation and content type
- [x] Honor configured output paths for standard runs and reruns
  - [x] Unify path resolver across normal runs and retries
  - [ ] Show explicit warning only on write failures; avoid silent Desktop fallback
- [ ] Correct date filter behavior for start-only and end-only
  - [ ] Update filter predicates and add unit test coverage
- [ ] Handle network loss during generation without orphaned "Running" jobs
  - [ ] Add timeout/error transition to Failed with Retry
  - [ ] Reconcile UI polling to reflect final state
- [ ] On app startup, reconcile orphaned "Running" jobs to Failed
  - [ ] Implement startup reconciliation and add migration if needed
- [ ] Implement "Has pending retries" filter logic
  - [ ] Wire predicate to show parent jobs awaiting retry spawn
- [ ] Ensure Remove.bg size is honored everywhere
  - [ ] Verify param mapping from UI to backend; fix enum mapping
- [ ] Unify Single Job View export UI with new modal
  - [ ] Use same modal; target single .xlsx export
- [ ] Eliminate QC Retry flicker by reducing unnecessary re-renders
  - [ ] Replace full-list refresh with local state patch
- [ ] Complete Remove.bg size options in Retry modal
  - [ ] Mirror Settings dropdown values
- [ ] Replace text fields with sliders for sharpening/saturation in Retry modal
  - [ ] Reuse Settings slider components
- [ ] Investigate backend error at app launch and fix root cause
  
### Completed: WebP and Processing UX
- [x] Add WebP conversion via sharp; introduce WebP Quality (1–100), default 85
- [x] Keep PNG conversion lossless; remove PNG Quality controls from UI and displays
- [x] Surface WEBP/JPG quality conditionally in Settings, Single Job View Edit, Retry modal
- [x] Fix retry flows to respect WEBP conversion/quality; ensure snapshots and modals show correct values

### Implemented (Out-of-scope but completed in 1.19)
- [x] Persist execution-level configuration snapshots and surface in UI (Single Job View Overview, Image Modals Processing)
- [x] Prefer per-image `processingSettings` only when retry customized values
- [x] Gate Runware Advanced by `runwareAdvancedEnabled` across Settings, Edit modal, backend saves, rerun execution
- [x] Standardize local file URLs with `buildLocalFileUrl` for renderer image loads

### New Tasks (WebP and Processing UX)
- [ ] Add WebP conversion via sharp; map “PNG Quality” control to “WebP Quality” when WebP selected
- [ ] Allow Remove.bg + Trim Transparent to work with WebP outputs (still gated by Remove.bg = ON)
- [ ] Rename quality label contextually (e.g., “WebP Quality”)

## Definition of Done
- [ ] All Blocking and Major issues resolved and verified manually.
- [ ] Unit/Integration/E2E tests updated where feasible.
- [ ] No sensitive data in logs; errors are actionable.
- [ ] Lint/tests green.

## Risks
- Fixes may touch shared pipelines (save paths, job state), risking regressions—guard with tests and staged commits.

## Story Points
5

## Backlog Notes
- Consider adding 429/backoff handling in a future story if needed.
