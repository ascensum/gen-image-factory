### 1.19 Remove.bg “Mark Failed” enforcement and debug status

#### Context
- Goal: When Remove.bg fails and failure mode is set to `mark_failed`, images must be marked `qc_failed` with reason `processing_failed:remove_bg` and must not move to the final output directory.
- Problem reported: Even with invalid/missing Remove.bg key and failure mode = Mark Failed, images sometimes remained Approved and were moved (or reconciled) to final. Logs suggested old code was running at times.

#### Changes implemented in this iteration
- jobRunner
  - Per-image guard `skipFinalDueToMarkFailed` to prevent any move-to-final when `removeBg=true` and `removeBgFailureMode='mark_failed'` unless Remove.bg actually applied.
  - Reconcile guard to skip all approved-image reconciliation when job’s processing is in `mark_failed` mode (`approved_no_final_move_skip_mark_failed`).
  - Force `qc_failed` in all Mark Failed paths (with numeric-id fallback and in-memory update):
    - Missing API key
    - Remove.bg did not apply
    - Soft Remove.bg failure recorded
    - Processing threw (catch)
    - Both new skip-move guards (pre/post)
  - Consolidated override: if in Mark Failed mode and any of (throw | soft-fail | not-applied), then force `qc_failed` and continue (no move). Marker: `qc_pass_processing_consolidated_override`.
  - Structured logging added/standardized:
    - qc_pass_processing_flags
    - qc_pass_processing_source
    - qc_pass_processing_start
    - qc_pass_processing_missing_key_mark_failed
    - qc_pass_processing_not_applied_mark_failed
    - qc_pass_processing_soft_removebg_mark_failed
    - qc_pass_processing_catch
    - qc_pass_processing_mark_failed
    - qc_pass_processing_skip_move
    - qc_pass_processing_skip_move_guard
    - qc_pass_processing_skip_move_guard_post
    - qc_pass_processing_consolidated_override
    - approved_no_final_move_skip_mark_failed
  - DB persistence improvements:
    - First try `updateQCStatusByMappingId(mappingKey, 'qc_failed', ...)`.
    - If changes === 0 and `mappingKey` looks numeric, also try `updateQCStatus(Number(mappingKey), ...)`.
    - Update in-memory `dbImg.qcStatus/qcReason` and add to `_markFailedMappingIds`.

- producePictureModule
  - In hard-fail path: set `config._removeBgApplied = false` and append a `remove_bg` entry to `config._softFailures` before throwing. This guarantees the caller can detect non-applied hard-fail and flip QC in a consolidated manner.

#### Key files
- src/services/jobRunner.js
- src/producePictureModule.js
- src/database/models/GeneratedImage.js (update methods used; unchanged in this iteration)

#### Reproduction (dev)
1. Ensure app is launched from the repo (not a packaged app). Clear Vite/Electron caches if necessary and relaunch dev.
2. Set Remove.bg key invalid/missing. Set “On remove.bg failure” to “Mark Failed (Technical)” in global or per-job settings.
3. Run a job (1 image is enough). Observe logs.

Expected now:
- Image either never moves to final or any reconcile is skipped.
- Image QC status is updated to `qc_failed` with reason `processing_failed:remove_bg`.
- One of the override/mark_failed markers appears.

#### Useful greps
```bash
grep -E \"QC-pass|qc_pass_processing_|approved_no_final_move|marking image qc_failed|QC status updated successfully\" /Users/<you>/Development/git_repos/gen-image-factory/debug-logs/electron-debug-*.log | tail -n 300
```
Looking specifically for:
- `qc_pass_processing_missing_key_mark_failed`
- `qc_pass_processing_not_applied_mark_failed`
- `qc_pass_processing_soft_removebg_mark_failed`
- `qc_pass_processing_catch`
- `qc_pass_processing_mark_failed`
- `qc_pass_processing_consolidated_override`
- `approved_no_final_move_skip_mark_failed`

Note: The log files show the message text; `subStep` tokens appear only in the structured log data (UI). We prefixed many messages to aid grep.

#### Current status / Remaining issue
- In some runs, logs show Remove.bg hard-fail and reconcile skip, but the image remains Approved (no `qc_failed` overwrite observed).
- Missing expected markers like `qc_pass_processing_mark_failed` or `qc_pass_processing_consolidated_override` after the hard-fail suggests the post-QC override path may not be executing (or logs are from an older build).
- Mapping ID mismatches are possible; numeric-id fallback has been added to QC update calls.

#### Hypotheses to validate
- The Remove.bg throw path bypasses our structured log section (e.g., different code path or an early return before catch).
- The running process is still not using the latest jobRunner (confirm with a sentinel string edit in logs).
- `image_mapping_id` stored in DB doesn’t match `mappingKey` used in updates (verify `changes > 0`).
- UI displaying stale state (not reflecting the DB change made by the override).

#### Next actions for handoff
- Confirm build: add a temporary version tag to a structured message (e.g., `QC-pass flags [v3] …`) and verify in the log file.
- After a Remove.bg failure, immediately query DB for the affected image row by `executionId` and `image_mapping_id`; assert `qc_status='qc_failed'`.
- If row isn’t updated, log `mappingKey` + perform a direct DB select to compare against stored `image_mapping_id` (identify mismatch).
- If row is updated but UI shows Approved, trigger a UI refresh of logs/images after QC-pass overrides.
- Consider persisting an explicit “processingOutcome.removeBgApplied=false” field in `processingSettings` to make downstream logic and audits clearer.

#### Environment tips
- Start dev with logging to file (example):
```bash
mkdir -p debug-logs && LOGFILE=\"debug-logs/electron-debug-$(date +%Y%m%d_%H%M%S).log\" && ELECTRON_ENABLE_LOGGING=1 ELECTRON_ENABLE_STACK_DUMPING=1 npm run electron:dev 2>&1 | tee \"$LOGFILE\"
```
- To force rebuild: remove `.vite`, `node_modules/.vite`, `dist*`, Electron caches, then run dev.

#### Acceptance criteria (post-fix)
- With Remove.bg failure and failure mode = Mark Failed:
  - Image ends with `qc_status='qc_failed'`, `qc_reason='processing_failed:remove_bg'`.
  - No move-to-final occurs and reconcile is skipped.
  - Logs include one of the override markers or the explicit mark_failed marker.


