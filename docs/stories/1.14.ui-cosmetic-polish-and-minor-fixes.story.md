# Story 1.14: UI Cosmetic Polish & Minor Fixes (Ongoing Small PR Lane)

## Status
Ready to Implement

## Story
As a product owner and end user,
I want incremental cosmetic improvements delivered continuously via small commits,
so that the UI feels consistent, tidy, and professional without risk to functionality.

## Acceptance Criteria
1. Scope limited to non‑functional visual polish unless explicitly approved (no behavior changes).
2. Approved focus areas include:
   - Alignment, spacing, typography, icon sizes, and color consistency
   - Status badge styles and label capitalization
   - Hover/focus states and interactive affordances
   - Microcopy clarity (grammar, punctuation), without changing meaning
3. No layout regressions (visual diff or manual spot check across dashboard, job management, settings, and results views).
4. Commits are small, well‑scoped, and easy to review (< ~150 lines changed where possible).
5. Each commit updates a brief change log entry (what changed, why, before/after screenshot when helpful).
6. Visual changes pass existing unit/E2E tests and eslint/style checks.

## Process
- Intake: PO will provide an ongoing list of small tweaks; maintain a running checklist in this story.
- Execution: Submit small commits continuously; each commit references this story with a checklist item.
- Validation: Reviewer confirms no behavior changes and no layout regressions; merge behind regular safeguards.

## Tasks / Subtasks
- [x] Align 'Add to Retry' blue button size in Failed Image Review modal with Single Job View action buttons.
- [x] Override inherited/global styles via custom class to ensure consistent button sizing in Failed Image Review modal.
- [x] Add Delete button to Image Gallery Single Image modal header; wire to cascading delete (DB + filesystem) via parent handler.
- [x] Keep Image Gallery modal open after delete and navigate to next (or previous if last).
  - [x] Fix type mismatch bug in ID comparisons (String conversion)
  - [x] Implement synchronous modal state updates via flushSync
  - [x] Create separate delete flow to bypass parent refresh
  - [x] Add modal lock mechanism to prevent premature closure
  - [x] Implement deferred background refresh for gallery grid
- [x] Apply same delete navigation behavior to Failed Images Review Single Image Modal.
- [x] Match delete button sizing with Failed Images Review modal (shared class).
- [x] Fix visual flash/zoom reset issue in Failed Images Review Single Image Modal.
  - [x] Eliminate modal unmount/remount cycle during navigation
  - [x] Extract modal to separate container component with React Portal
  - [x] Implement optimistic UI updates to prevent infinite loops on delete
  - [x] Extend auto-navigation behavior to Approve and Add to Retry actions
  - [x] Unified workflow: all three actions (Delete/Approve/Retry) navigate to next image

## Definition of Done
- [ ] A first batch of small UI polish PRs merged with no regressions.
- [ ] Checklist in this story seeded and trackable for next iterations.
- [ ] Visual consistency improved across at least 3 major surfaces (dashboard, job management, settings, results).
- [ ] Tests and lints remain green.

## Risks
- Small PRs may accumulate unnoticed style drift; keep a brief design token reference and component examples.
- Avoid functional changes unless explicitly approved to reduce regression risk.

## Story Points
2 (ongoing lane)

## Dev Agent Record

### Implementation Notes

#### Modal Delete Navigation Fix (2025-11-07)

**Issue:** Single Image Modals (Image Gallery & Failed Images Review) closed immediately after clicking Delete button instead of staying open and navigating to next image.

**Root Causes:**
1. Type mismatch - Image IDs compared as number vs string, causing `findIndex` to return -1
2. Parent component polling/refresh interfered with modal state
3. Immediate refresh triggered modal closure

**Solution Applied to Both Modals:**
- Type-safe ID comparisons using `String()` conversion
- Synchronous modal state updates via `flushSync()` from `react-dom`
- Separate delete flow bypassing parent handler (direct API call)
- Modal lock mechanism (`deletingImageRef`, `modalLockedRef`) to prevent premature closure
- Image caching (`modalImageCache`) for smooth transitions
- Deferred background refresh (100ms + 50ms) to update grid without closing modal

**Files Modified:**
- `src/renderer/components/Dashboard/ImageGallery.tsx`
- `src/renderer/components/Dashboard/FailedImagesReviewPanel.tsx`
- `src/renderer/components/Dashboard/FailedImageReviewModal.tsx` (added optional `onDelete` prop)

---

#### Failed Images Review Modal Architecture Refactor (2025-11-08)

**Issue:** After implementing delete navigation, the Failed Images Review modal exhibited a visual flash and zoom reset when navigating between images. This occurred despite the zoom/pan state tracking working correctly.

**Root Cause Analysis:**
1. **Modal Unmount/Remount Cycle:** The `FailedImagesReviewPanel` component was remounting whenever `loadAllImageStatuses()` was called after each action
2. **Parent Re-renders:** When the panel remounted, all child components (including the modal) unmounted and remounted, losing internal state (zoom, pan, etc.)
3. **Infinite Loop on Delete:** Deleted images remained in `filteredAndSortedImages` array, causing the modal to navigate to already-deleted images repeatedly
4. **React Internal Warnings:** Initial attempts using `React.memo` with Portal caused React reconciliation conflicts

**Why This Refactor Was Necessary:**
- **User Experience:** The flash/zoom reset was jarring and broke the continuous review workflow
- **Architectural Flaw:** Modal component lifecycle was tightly coupled to parent data refresh cycles
- **Workflow Efficiency:** Users needed to review/approve/retry multiple images in sequence without modal closure or state loss

**Solution: React Portal + Optimistic Updates**

Created `FailedImageModalContainer` component with the following architecture:

1. **React Portal Isolation:**
   ```typescript
   ReactDOM.createPortal(<FailedImageReviewModal />, document.body)
   ```
   - Renders modal directly to `document.body`, outside parent component tree
   - Modal survives parent unmount/remount cycles completely
   - State (zoom, pan, scroll position) persists across navigation

2. **Optimistic UI Updates:**
   ```typescript
   const [deletedImageIds, setDeletedImageIds] = useState<Set<string>>(new Set());
   
   // Filter deleted IDs immediately
   filteredAndSortedImages.filter(img => !deletedImageIds.has(String(img.id)))
   ```
   - Deleted/approved images removed from list instantly
   - Prevents navigation to stale images
   - Grid refreshes only when modal closes

3. **Unified Action Handlers:**
   - All three actions (Delete, Approve, Add to Retry) now share the same navigation logic:
     - Compute next image before action
     - Execute action (delete/approve/add to retry)
     - Navigate to next (or previous if last)
     - Close modal only when no images remain
   
4. **Container Pattern Benefits:**
   - Encapsulates modal state management
   - Decouples modal lifecycle from parent data fetching
   - Provides stable API surface with callback props
   - Lock mechanism prevents race conditions during actions

**Technical Implementation:**

**New Component:** `FailedImageModalContainer.tsx`
- Wraps `FailedImageReviewModal` with Portal
- Manages state: `modalImageCache`, `deletingImageRef`, `modalLockedRef`
- Provides handlers: `handleApprove`, `handleRetry`, `handleDelete`
- Passes navigation callbacks to modal

**Modified:** `FailedImagesReviewPanel.tsx`
- Added `deletedImageIds` state for optimistic updates
- Removed immediate `loadAllImageStatuses()` calls during actions
- Deferred refresh to modal close: `onClose={() => { setDeletedImageIds(new Set()); loadAllImageStatuses(); }}`
- Added dedicated handlers for each action type

**Modified:** `FailedImageReviewModal.tsx`
- Added optional props: `onApprove`, `onRetry` (in addition to existing `onDelete`)
- Button handlers now use dedicated callbacks instead of generic `onAction`
- Maintains zoom/pan state tracking (unchanged)

**Result:**
- ✅ No flash or zoom reset during navigation
- ✅ Smooth transitions between images
- ✅ Deleted images disappear immediately
- ✅ All actions (Delete/Approve/Retry) auto-navigate
- ✅ Modal stays open for continuous workflow
- ✅ Grid updates when modal closes
- ✅ No React warnings or performance issues

**Files Modified:**
- `src/renderer/components/Dashboard/FailedImageModalContainer.tsx` (new file)
- `src/renderer/components/Dashboard/FailedImagesReviewPanel.tsx` (major refactor)
- `src/renderer/components/Dashboard/FailedImageReviewModal.tsx` (prop additions)
- `src/renderer/components/Dashboard/index.ts` (export added)

## Backlog
- (empty; add incoming cosmetic tweaks here, to be promoted into Tasks/Subtasks as executed)

