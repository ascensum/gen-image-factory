#!/bin/sh
set -e

echo "[husky] Running critical regression suite (non-interactive)"

# 1) Core backend/job management suites
npm run -s test:job-management
npm run -s test:retry

# 2) Focused UI guards (jsdom) and utils (node) - split to avoid native crashes
npx vitest run src/renderer/components/Jobs/__tests__/SingleJobView.settings-save.test.tsx --reporter=dot --environment=jsdom
npx vitest run src/renderer/components/Jobs/__tests__/SingleJobView.statistics.test.tsx --reporter=dot --environment=jsdom
npx vitest run src/renderer/components/Jobs/__tests__/SingleJobView.delete-refresh.test.tsx --reporter=dot --environment=jsdom
npx vitest run src/renderer/components/Jobs/__tests__/JobLabelDisplay.test.tsx --reporter=dot --environment=jsdom
npx vitest run src/renderer/components/Settings/__tests__/Parameters.behavior.test.tsx --reporter=dot --environment=jsdom
npx vitest run src/renderer/components/Settings/__tests__/RetryControls.persistence.test.tsx --reporter=dot --environment=jsdom
npx vitest run src/renderer/components/Jobs/__tests__/SingleJobView.retryControls.persistence.test.tsx --reporter=dot --environment=jsdom

npx vitest run tests/unit/utils/processing.normalizer.test.ts --reporter=dot

# 3) Backend label integration tests isolated (prevent sqlite3 worker crash)
# Run backend integration tests serially in separate invocations
npx vitest run tests/integration/backend/FallbackLabelUnification.integration.test.ts --reporter=dot
npx vitest run tests/integration/backend/LabelNoOverwriteOnCompletion.integration.test.ts --reporter=dot
npx vitest run tests/integration/backend/RenameUpdatesConfiguration.integration.test.ts --reporter=dot
npx vitest run tests/integration/backend/RerunLabelPersistence.integration.test.ts --reporter=dot
npx vitest run tests/integration/backend/NewJobExecutionIsolation.integration.test.ts --reporter=dot

# 4) New backend unit tests for per-generation retry/parameter regeneration
npx vitest run tests/unit/services/JobRunner.generationRetry.test.ts --reporter=dot
npx vitest run tests/unit/services/JobRunner.parameterRegeneration.test.ts --reporter=dot

echo "[husky] All critical tests passed"
